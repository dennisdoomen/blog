---

title: Ingredients for well-designed OWIN middleware components - Part 2
date: '2015-07-20T07:37:00.001+02:00'

tags:
- OWIN Recipes
modified_time: '2015-10-09T10:08:48.193+02:00'
blogger_id: tag:blogger.com,1999:blog-15137028.post-6204941128082347860
blogger_orig_url: http://www.continuousimprover.com/2015/07/ingredients-for-well-designed-owin.html
---

<div lang="en-US" style="margin: 0in;"><span style="font-family: inherit;">In my </span><a href="http://www.continuousimprover.com/2015/07/recipes-for-well-designed-owin.html" style="font-family: inherit;">last post</a><span style="font-family: inherit;">, I talked about naming conventions and reducing the number of public&nbsp;</span>dependencies<span style="font-family: inherit;">, the first two&nbsp;ingredients of a recipe for well-designed OWIN middleware components. In this post, I'm going to talk about separating the OWIN pipeline construction from the middleware definition.</span></div><div lang="en-US" style="margin: 0in;"><br /><b>Ingredient 3: Keeping your pipeline construction clean</b></div><div lang="en-US" style="margin: 0in;"><span style="font-family: inherit;">The first version of the </span><span style="font-family: Courier New, Courier, monospace;">UsePiercer </span><span style="font-family: inherit;">extension method, before I added the settings argument, looked something like this:</span></div><div lang="en-US" style="margin: 0in;"><br /></div><div style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">public static IAppBuilder UsePiercer(this IAppBuilder appBuilder)</span></div><div style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">{</span></div><div style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">&nbsp; HttpConfiguration configuration = BuildHttpConfiguration();</span></div><div style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">&nbsp; appBuilder.Map("/api", a =&gt; a.UseWebApi(configuration));</span></div><div style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;"><br /></span></div><div style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">&nbsp; return appBuilder;</span></div><div style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">}</span></div><div lang="en-US" style="margin: 0in;"><br /></div><div lang="en-US" style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">IAppBuilder</span><span style="font-family: inherit;">is defined by the <a href="https://www.nuget.org/packages/Owin/">Owin</a>package, but that </span><span style="font-family: Courier New, Courier, monospace;">Map</span><span style="font-family: inherit;"> method is an extension method defined in </span><span style="font-family: Courier New, Courier, monospace;">Microsoft.Owin</span><span style="font-family: inherit;">, part of Microsoft's Katana project. Since </span><span style="font-family: Courier New, Courier, monospace;">IAppBuilder</span><span style="font-family: inherit;"> is on that public method, you can't internalize it. Your package will need to retain a dependency on the </span><span style="font-family: Courier New, Courier, monospace;">Owin</span><span style="font-family: inherit;"> package. </span><span style="font-family: Courier New, Courier, monospace;">Microsoft.Owin</span><span style="font-family: inherit;"> however, is only used within that method. Merging it in your assembly sounds like a smart thing to do. </span></div><div lang="en-US" style="margin: 0in;"><br /></div><div lang="en-US" style="margin: 0in;"><span style="font-family: inherit;">However, without discussing the&nbsp;</span>intricacies<span style="font-family: inherit;">&nbsp;of </span><a href="http://benfoster.io/blog/how-to-write-owin-middleware-in-5-different-steps" style="font-family: inherit;">AppFuncs and MidFuncs</a><span style="font-family: inherit;">, it suffices to know that when the OWIN host is finalizing the construction of the OWIN pipeline (by calling the </span><span style="font-family: Courier New, Courier, monospace;">Build</span><span style="font-family: inherit;"> method of </span><span style="font-family: Courier New, Courier, monospace;">AppBuilder</span><span style="font-family: inherit;">), some magic conversion happens between a hidden </span><span style="font-family: Courier New, Courier, monospace;">AppBuilder</span><span style="font-family: inherit;"> (which is Microsoft's implementation of </span><span style="font-family: Courier New, Courier, monospace;">IAppBuilder</span><span style="font-family: inherit;">) to an Owin </span><span style="font-family: Courier New, Courier, monospace;">MidFunc</span><span style="font-family: inherit;">. If you merge </span><span style="font-family: Courier New, Courier, monospace;">Microsoft.Owin</span><span style="font-family: inherit;">into your assembly, your host won't be able to find the conversion and some weird </span><span style="font-family: Courier New, Courier, monospace;">InvalidCastException</span><span style="font-family: inherit;"> will happen. You can solve that by separating the act of adding middleware to the </span><span style="font-family: Courier New, Courier, monospace;">IAppBuilder</span><span style="font-family: inherit;"> from the construction of the middleware itself. In Piercer I used this construction:</span></div><div lang="en-US" style="margin: 0in;"><br /></div><div lang="en-US" style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">public static IAppBuilder UsePiercer(this IAppBuilder appBuilder)</span></div><div lang="en-US" style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">{</span><br /><span style="font-family: 'Courier New', Courier, monospace;">&nbsp; appBuilder.Use(Middleware.Create(settings));</span><br /><span style="font-family: 'Courier New', Courier, monospace;">&nbsp; return appBuilder;</span></div><div lang="en-US" style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">}</span></div><div lang="en-US" style="margin: 0in;"><br /></div><div lang="en-US" style="margin: 0in;"><span style="font-family: inherit;">Where the </span><span style="font-family: Courier New, Courier, monospace;">Middleware</span><span style="font-family: inherit;"> class returns a </span><span style="font-family: Courier New, Courier, monospace;">MidFunc</span><span style="font-family: inherit;">:</span></div><div lang="en-US" style="margin: 0in;"><br /></div><div lang="en-US" style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">public static Func<appfunc appfunc=""><appfunc appfunc=""><appfunc appfunc="">&nbsp;Create()</appfunc></appfunc></appfunc></span></div><div lang="en-US" style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">{</span><br /><span style="font-family: 'Courier New', Courier, monospace;">&nbsp; return next =&gt;</span><br /><span style="font-family: 'Courier New', Courier, monospace;">&nbsp; {</span><br /><span style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; var appBuilder = new AppBuilder();</span><br /><span style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp;&nbsp;</span><br /><span style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; HttpConfiguration configuration =</span><br /><span style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; &nbsp; BuildHttpConfiguration(settings);</span><br /><span style="font-family: 'Courier New', Courier, monospace;"><br /></span><span style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; appBuilder.Map(settings.Route, a =&gt; a.UseWebApi(configuration));</span><br /><span style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; appBuilder.Run(ctx =&gt; next(ctx.Environment));</span><br /><span style="font-family: 'Courier New', Courier, monospace;"><br /></span><span style="font-family: 'Courier New', Courier, monospace;">&nbsp; &nbsp; return appBuilder.Build();</span><br /><span style="font-family: 'Courier New', Courier, monospace;">&nbsp; };</span></div><div lang="en-US" style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">}</span></div><div lang="en-US" style="margin: 0in;"><br /></div><div lang="en-US" style="margin: 0in;"><span style="font-family: inherit;">I understand that it might be a bit difficult to read (although the functional guys love this stuff ). The point is that you force this magic conversion from a nested </span><span style="font-family: Courier New, Courier, monospace;">AppBuilder</span><span style="font-family: inherit;"> to the </span><span style="font-family: Courier New, Courier, monospace;">MidFunc</span><span style="font-family: inherit;"> even before you add the middleware to the pipeline. If you take this approach, you can safely merge Microsoft.Owin into your main assembly.&nbsp;</span></div>