---

title: 'My Silverlight 4 Reference Architecture: Commanding'
date: '2010-10-08T07:02:00.002+02:00'

tags:
- dotnetmag
- CQRS
- Architecture
- Silverlight
modified_time: '2010-10-12T08:30:19.815+02:00'
thumbnail: http://lh5.ggpht.com/_sv2gnsft17w/TK6l4D4K_SI/AAAAAAAAGoo/lavydZZU508/s72-c/clip_image001_thumb%5B6%5D.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-15137028.post-747940296547750531
blogger_orig_url: http://www.continuousimprover.com/2010/10/my-silverlight-4-reference-architecture.html
---

<p  $1="$1"></p>  <p  $1="$1">After sharing my thoughts on <a href="http://www.dennisdoomen.net/2010/09/getting-more-out-of-unit-testing-in.html">unit testing in Silverlight</a> and the combination of <a href="http://www.dennisdoomen.net/2010/09/some-thoughts-on-wcf-data-services-and.html">NHibernate and WCF Data Services</a>, it is time to discuss the updated version of the Silverlight <a href="http://www.dennisdoomen.net/2009/07/defining-reference-architecture-for.html">reference architecture</a> from one of my posts of last year. To put the discussion into perspective, here is a diagram illustrating the layers, components and supporting frameworks I use, and which I will refer to in the coming posts.</p>  <p  $1="$1"></p>  <p  $1="$1"><a href="http://lh5.ggpht.com/_sv2gnsft17w/TK6l3ilMR6I/AAAAAAAAGog/QTCsVCWQ2ks/s1600-h/clip_image001%5B9%5D.png"><img style="background-image: none; border-right-width: 0px; padding-left: 0px; padding-right: 0px; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="clip_image001" border="0" alt="clip_image001" src="http://lh5.ggpht.com/_sv2gnsft17w/TK6l4D4K_SI/AAAAAAAAGoo/lavydZZU508/clip_image001_thumb%5B6%5D.png?imgmax=800" width="566" height="535" /></a>     <br /></p>  <p  $1="$1"></p>  <p  $1="$1">I've seen many projects stumble on the decision on how to expose the domain model via web services. And more often than that, I've received questions on how to deal with the granularity of DTOs versus domain entities. To overcome that problem myself, I decided to include some aspects of the <a href="http://cqrs.wordpress.com/">CQRS</a> principle. Changes to the domain are now solely tunneled through one or more <strong>Commands</strong>, and queries are executed on a dedicated <strong>REST Service</strong>.</p>  <p  $1="$1">Commands have several advantages. They are expressed in the <a href="http://www.dennisdoomen.net/2010/08/alm-practices-part-9-ubiquitous.html">Ubiquitous Language</a> which lowers the threshold between the developers and the business. There is no need for any tedious and elaborate conversions between incoming DTOs and domain entities. </p>  <p>And because those commands are already very business-oriented, the <strong>Command Handlers</strong> replace the traditional domain services that you often find in a system build around <a href="http://domaindrivendesign.org/">DDD</a> concepts. And although a task-based UI is better suited for an architecture like is, I managed to break down the user interaction of a CRUD-style application into logical commands without too much trouble. </p>  <p>Because they are very focused they often can be directly mapped to corresponding methods on the aggregate root in the <strong>Domain Model</strong>. That's why I use a generic command handler that uses mapping attributes and conventions (an idea I borrowed from the <a href="http://ncqrs.org/">NCQRS</a> framework) to map entity references to the actual entity instances. The following example for instance, maps a command to the equally named method of the Registration aggregate root. </p>  <p  $1="$1"></p>  <div style="line-height: normal; margin: 0in 0in 0in 0.375in" lang="en-US"><span style="font-family: calibri"><span style="color: black"><span style="font-size: 11pt">&#160;&#160;&#160; [</span></span><span style="font-size: 11pt"><span style="color: darkblue">DataContract</span><span style="color: black">]          <br /></span></span></span><span style="font-family: calibri"><span style="color: black"><span style="font-size: 11pt">&#160;&#160;&#160; [</span></span><span style="font-size: 11pt"><span style="color: darkblue">MapsToAggregateRootMethod</span><span style="color: black">(</span><span style="color: blue">typeof</span><span style="color: black">(</span><span style="color: darkblue">Registration</span><span style="color: black">), </span><span style="color: #a31515">&quot;ChangeShelfLife&quot;</span><span style="color: black">)]          <br /></span></span></span><span style="font-family: calibri"><span style="color: black"><span style="font-size: 11pt">&#160;&#160;&#160; </span></span><span style="font-size: 11pt"><span style="color: blue">public</span><span style="color: black">&#160;</span><span style="color: blue">class</span><span style="color: black">&#160;</span><span style="color: darkblue">ChangeShelfLifeCommand</span><span style="color: black"> : </span></span><span style="color: darkblue; font-size: 11pt">VersionedCommand        <br /></span></span><span style="font-family: calibri"><span style="color: black; font-size: 11pt">&#160;&#160;&#160; {        <br /></span></span><span style="font-family: calibri"><span style="color: black"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; [</span></span><span style="font-size: 11pt"><span style="color: darkblue">DataMember</span><span style="color: black">(</span><span style="color: purple">IsRequired</span><span style="color: black"> = </span><span style="color: blue">true</span><span style="color: black">)]          <br /></span></span></span><span style="font-family: calibri"><span style="color: black"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span></span><span style="font-size: 11pt"><span style="color: blue">public</span><span style="color: black">&#160;</span><span style="color: blue">string</span><span style="color: black">&#160;</span><span style="color: purple">PresentationName</span><span style="color: black"> { </span><span style="color: darkcyan">get</span><span style="color: black">; </span><span style="color: darkcyan">set</span><span style="color: black">; }          <br />          <br /></span></span></span><span style="font-family: calibri"><span style="color: black"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; [</span></span><span style="font-size: 11pt"><span style="color: darkblue">DataMember</span><span style="color: black">(</span><span style="color: purple">IsRequired</span><span style="color: black"> = </span><span style="color: blue">true</span><span style="color: black">)]          <br /></span></span></span><span style="font-family: calibri"><span style="color: black"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span></span><span style="font-size: 11pt"><span style="color: blue">public</span><span style="color: black">&#160;</span><span style="color: blue">int</span><span style="color: black">&#160;</span><span style="color: purple">ShelfLife</span><span style="color: black"> { </span><span style="color: darkcyan">get</span><span style="color: black">; </span><span style="color: darkcyan">set</span><span style="color: black">; }          <br /></span></span></span><span style="font-family: calibri"><span style="color: black; font-size: 11pt">&#160;&#160;&#160; }        <br /></span></span></div>  <p  $1="$1"></p>  <p  $1="$1">This example illustrates two other aspects of my implementation: that each command is a WCF data contract, and that most commands are supposed to be applied to a specific version of an aggregate root. The latter is not required, but it occurs that often that I created a simple base class for that. The signature of the single operation of the <strong>Command Service</strong> is:     <br /></p>  <p  $1="$1"></p>  <div style="line-height: normal; margin: 0in 0in 0in 0.375in" lang="en-US"><span style="font-family: calibri"><span style="color: black"><span style="font-size: 11pt">&#160;&#160;&#160; </span></span><span style="font-size: 11pt">[<span style="color: darkblue">OperationContract</span></span><span style="font-size: 11pt">]        <br /></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160; </span><span style="font-size: 11pt"><span style="color: blue">public</span>&#160;<span style="color: blue">string</span>&#160;<span style="color: darkcyan">Execute</span>(<span style="color: darkblue">IEnumerable</span>&lt;<span style="color: darkblue">Command</span></span><span style="font-size: 11pt">&gt; commands) { }</span></span></div>  <p  $1="$1"></p>  <p  $1="$1">Which means I can pass a whole batch of commands from the Silverlight client back to the command service. </p>  <p>In the <a href="http://www.dennisdoomen.net/2010/10/my-silverlight-4-reference-architecture_12.html">next</a> part, Iâ€™ll discuss the querying aspects of this architecture.</p>  