---

title: 'ALM Practices Part 8: Automatic Builds & Continuous Integration'
date: '2010-07-04T22:13:00.001+02:00'

tags:
- ALM Practices
- TFS
- ALM
modified_time: '2010-08-17T09:44:16.495+02:00'
blogger_id: tag:blogger.com,1999:blog-15137028.post-6988704995528687189
blogger_orig_url: http://www.continuousimprover.com/2010/07/alm-practices-part-8-automatic-builds.html
---

<p><strong>What is it?</strong>     <br />An automatic build is a fully automated compilation of a specific version of your source code repository and which runs at regular intervals. More often than not, such a build includes additional steps such as running a <a href="http://www.dennisdoomen.net/2010/04/alm-practices-6-code-analysis.html">static code analysis</a> and code coverage, executing all automatic unit and integration tests, and possibly even a full-blown deployment of the product and the database to a test server. Continuous Integration, or CI, is just a fancy name for saying that a build runs whenever a developer checks-in his changes into the source code repository. This essentially forces all developers to continuously integrate their changes into a working product. However, since these kind of builds are run very frequently, extra steps are usually limited to unit tests and code coverage.</p>  <p><strong>Why would you do it?</strong>     <br /></p>  <ul>   <li>Because two developers each working in the same area of the code base cannot fully guarantee that their changes will not cause any functional issues. </li>    <li>Because the deployment of a new release to a development, test or acceptance server usually involves many manual steps, each highly susceptible to errors. </li>    <li>Because deploying your product or system in an automated way requires that it has been built for that. Introducing an automatic daily deployment forces you to deal with possible issues early in the project which would not have appeared until the final release date otherwise. </li>    <li>Because it then becomes trivial to redeploy an earlier version of your product or system, for instance when a new release includes some critical bugs and you want to roll back, or to analyze functional changes between versions. </li> </ul> <strong>What’s the bare minimum you need to do?</strong>   <br />  <ul>   <li>Use a continuous integration build that compiles your solutions and runs your unit tests. </li> </ul> <strong>What’s the usual thing to do?</strong>   <br />  <ul>   <li>Deploy the most recent version of your product or system to your central development server. </li>    <li>Automatically deploy the database schema changes and test data to your central database. </li>    <li>Include a build step that assigns a unique version number to all executables and DLLs so that you can easily see which version is deployed. </li> </ul> <strong>How do you do that?</strong>   <br />Setup a Continuous Integration build in Team Foundation Server 2008 or 2010 using the following steps:   <br />  <ul>   <li>Create a dedicated Build Definition in <a href="http://msdn.microsoft.com/en-us/library/ms181286(VS.90).aspx">Team Build 2008</a> or <a href="http://msdn.microsoft.com/en-us/library/ms181716.aspx">Team Build 2010</a> for every solution related to your product or system and configure it so that is triggered by every check-in. </li>    <li>Don’t forget to configure your definition to build the release version of your solution. </li>    <li>Optionally, <a href="http://msdn.microsoft.com/en-us/library/bb668977.aspx">configure</a> the build to enable <a href="http://www.dennisdoomen.net/2010/04/alm-practices-6-code-analysis.html">Code Analysis</a> using the project-specific settings. Read <a href="http://seesharper.wordpress.com/2010/04/02/code-analysis-in-team-build-2010/">this</a> post on how to configure this using the Default Template in Team Build 2010. </li>    <li>Use the <a href="http://blogs.microsoft.co.il/blogs/dhelper/archive/2010/06/24/how-to-run-your-unit-tests-as-part-of-tfs-build.aspx">&lt;TestContainer&gt;</a> element to configure which test assemblies to inspect for unit tests, or use a wildcard, for instance *\**\*.specs.dll to run all test in assemblies post-fixed with .specs.dll. </li>    <li>If your tests need a specific .testrunconfig, open up the underlying build.proj file and add a &lt;RunConfigFile&gt; element as explained by <a href="http://billwg.wordpress.com/2008/10/31/how-to-configure-tests-based-on-build-configuration/">this</a> post. </li>    <li>Notice that in Team Build 2010, you can skip the previous two steps and use the Build Definition dialog box instead. See <a href="http://geekswithblogs.net/jakob/archive/2009/06/03/tfs-team-build-2010-running-unit-tests.aspx">this</a> post for more info. </li>    <li>Make sure you keep the CI build fast, for instance by only running the unit tests that are independent of any slow resources such as I/O, databases, etc. </li>    <li>You can speed up the build by <a href="http://msdn.microsoft.com/en-us/library/aa833876(VS.80).aspx">enabling</a> the incremental build and disabling the step that copies the results to a dedicated network drop folder (configured through the <a href="http://blogs.msdn.com/b/aaronhallberg/archive/2008/02/12/team-build-2008-property-reference.aspx">&lt;SkipDropBuild&gt;</a> property. </li> </ul> Setup a Daily Build in Team Build 2008 that deploys the latest version to a dedicated test server using the following steps.   <br />  <ul>   <li>Use separate solution configurations to have project settings specific to the deployment environment. So in addition to the default Release and Debug configuration, you could introduce Test, Acceptance and Production configurations. </li>    <li>Introduce alternative .config files associated with specific solution configurations, such as for instance web.production.config or enterpriselibrary.production.config and configure Team Build 2008 to deploy the correct version using this block in your web application project: </li> </ul>  <blockquote><font size="2"><span style="font-family: courier new; font-size: x-small">&lt;Target Name=&quot;AfterBuild&quot; Condition=&quot;('$(Configuration)' != 'Debug') and ('$(Configuration)' != 'Release')&quot;&gt;</span>       <br /><span style="font-family: courier new; font-size: x-small">&lt;!-- If a configuration-specific web.config exists, replace the default web.config with it –&gt; </span><span style="font-family: courier new; font-size: x-small">&lt;Copy Condition=&quot;Exists('$(DeploymentFolder)\web.$(Configuration).config')&quot; SourceFiles=&quot;$(DeploymentFolder)\web.$(Configuration).config&quot; DestinationFiles=&quot;$(DeploymentFolder)\web.config&quot; /&gt;</span>       <br /><span style="font-family: courier new; font-size: x-small">&lt;Delete Files=&quot;$(DeploymentFolder)\web.$(Configuration).config&quot; /&gt;</span>       <br /><span style="font-family: courier new; font-size: x-small">&lt;!-- If a configuration-specific enterpriselibrary.config exists, replace the default enterpriselibrary.config with it –&gt; </span><span style="font-family: courier new; font-size: x-small">&lt;Copy Condition=&quot;Exists('$(DeploymentFolder)\enterpriselibrary.$(Configuration).config')&quot; SourceFiles=&quot;$(DeploymentFolder)\enterpriselibrary.$(Configuration).config&quot; DestinationFiles=&quot;$(DeploymentFolder)\enterpriselibrary.config&quot; /&gt;</span>       <br /><span style="font-family: courier new; font-size: x-small">&lt;Delete Files=&quot;$(DeploymentFolder)\enterpriselibrary.$(Configuration).config&quot; /&gt;</span>       <br /><span style="font-family: courier new; font-size: x-small">&lt;/Target&gt;</span></font></blockquote>  <ul>   <li>If you’re using Visual Studio 2010, you can reduce the amount of overlap between those alternative .config files using <a href="http://blog.hmobius.com/post/2010/02/17/ASPNET-40-Part-4-Config-Transformation-Files.aspx">Config Transformation Files</a>. </li>    <li>To deploy a web site using Team Build 2008 without the Web Deployment project, customize the .csproj of your Web Application project to automatically deploy the entire website to a dedicated server using the following example config. Notice that you need to set the $(DeploymentFolder) property to a valid UNC path. </li> </ul>  <blockquote><span style="font-family: courier new; font-size: x-small">&lt;Target Name=&quot;AfterBuild&quot; Condition=&quot;('$(Configuration)' != 'Debug') and ('$(Configuration)' != 'Release')&quot;&gt;</span>     <br /><span style="font-family: courier new; font-size: x-small">&lt;Message Text=&quot;Deploying Web Site to '$(DeploymentFolder)'.&quot; Importance=&quot;high&quot; /&gt;</span>     <br /><span style="font-family: courier new; font-size: x-small">&lt;!-- Create the _PublishedWebsites\app\bin folder –&gt; </span><span style="font-family: courier new; font-size: x-small">&lt;MakeDir Directories=&quot;$(DeploymentFolder)\bin&quot; /&gt;</span>     <br /><span style="font-family: courier new; font-size: x-small">&lt;!-- Copy build outputs to $(DeploymentFolder)\bin folder. –&gt; </span><span style="font-family: courier new; font-size: x-small">&lt;Copy SourceFiles=&quot;@(IntermediateAssembly)&quot; DestinationFolder=&quot;$(DeploymentFolder)\bin&quot; SkipUnchangedFiles=&quot;true&quot; /&gt;</span>     <br /><span style="font-family: courier new; font-size: x-small">&lt;Copy SourceFiles=&quot;@(AddModules)&quot; DestinationFolder=&quot;$(DeploymentFolder)\bin&quot; SkipUnchangedFiles=&quot;true&quot; /&gt;</span>     <br /><span style="font-family: courier new; font-size: x-small">&lt;Copy SourceFiles=&quot;$(IntermediateOutputPath)$(_SGenDllName)&quot; DestinationFolder=&quot;$(DeploymentFolder)\%(Content.SubFolder)%(Content.RecursiveDir)&quot; SkipUnchangedFiles=&quot;true&quot; Condition=&quot;'$(_SGenDllCreated)'=='true'&quot; /&gt;</span>     <br /><span style="font-family: courier new; font-size: x-small">&lt;Copy SourceFiles=&quot;$(IntermediateOutputPath)$(TargetName).pdb&quot; DestinationFolder=&quot;$(DeploymentFolder)\bin&quot; SkipUnchangedFiles=&quot;true&quot; Condition=&quot;'$(_DebugSymbolsProduced)'=='true'&quot; /&gt;</span>     <br /><span style="font-family: courier new; font-size: x-small">&lt;Copy SourceFiles=&quot;@(DocFileItem)&quot; DestinationFolder=&quot;$(DeploymentFolder)\bin&quot; SkipUnchangedFiles=&quot;true&quot; Condition=&quot;'$(_DocumentationFileProduced)'=='true'&quot; /&gt;</span>     <br /><span style="font-family: courier new; font-size: x-small">&lt;Copy SourceFiles=&quot;@(IntermediateSatelliteAssembliesWithTargetPath)&quot; DestinationFolder=&quot;$(DeploymentFolder)\bin&quot; SkipUnchangedFiles=&quot;true&quot; /&gt;</span>     <br /><span style="font-family: courier new; font-size: x-small">&lt;Copy SourceFiles=&quot;@(ReferenceComWrappersToCopyLocal); @(ResolvedIsolatedComModules); @(_DeploymentLooseManifestFile); @(NativeReferenceFile)&quot; DestinationFolder=&quot;$(DeploymentFolder)\bin&quot; SkipUnchangedFiles=&quot;true&quot; /&gt;</span>     <br /><span style="font-family: courier new; font-size: x-small">&lt;!-- copy any referenced assemblies to $(DeploymentFolder)\bin folder –&gt; </span><span style="font-family: courier new; font-size: x-small">&lt;Copy SourceFiles=&quot;@(ReferenceCopyLocalPaths)&quot; DestinationFolder=&quot;$(DeploymentFolder)\bin&quot; SkipUnchangedFiles=&quot;true&quot; /&gt;</span>     <br /><span style="font-family: courier new; font-size: x-small">&lt;!-- Copy content files recursively to $(DeploymentFolder)\bin folder –&gt; </span><span style="font-family: courier new; font-size: x-small">&lt;Copy SourceFiles=&quot;@(Content)&quot; DestinationFolder=&quot;$(DeploymentFolder)\%(Content.RelativeDir)&quot; /&gt;</span>     <br /><span style="font-family: courier new; font-size: x-small">&lt;/Target&gt;</span></blockquote>  <ul>   <li>To deploy a web site using the <a href="http://www.microsoft.com/downloads/details.aspx?familyid=89F2C4F5-5D3A-49B6-BCAD-F776C6EDFA63&amp;displaylang=en">Web Deployment</a> project type in Visual Studio 2010 project type, read <a href="http://blogs.msdn.com/b/webdevtools/archive/2010/05/26/visual-studio-2010-web-deployment-projects-rtw-available-now.aspx">this</a> post. </li>    <li>To deploy a web site using Team Build 2010 and MSDeploy, read <a href="http://www.ewaldhofman.nl/post/2010/04/11/Auto-deployment-of-my-web-application-with-Team-Build-2010-to-add-Interactive-Testing.aspx">this</a> post. </li>    <li>If you want to automatically add an incremented version number to all assemblies using Team Build 2008, read <a href="http://richardsbraindump.blogspot.com/2007/07/versioning-builds-with-tfs-and-msbuild.html">this</a> post. If you want to do this using Team Build 2010 with an Upgrade Template, read <a href="http://stuartpreston.net/blog/2010/05/02/simple-assembly-versioning-with-team-build-2010/">this</a>. And if you want to use the Default Template, read <a href="http://www.ewaldhofman.nl/post/2010/05/13/Customize-Team-Build-2010-e28093-Part-5-Increase-AssemblyVersion.aspx">this</a>. </li> </ul> If you also want to <a href="http://msdn.microsoft.com/en-us/library/aa833289.aspx">deploy the database</a> automatically, include the following additional steps.   <br />  <ul>   <li>Install Visual Studio Team System 2008 Database Edition and <a href="http://www.microsoft.com/downloads/details.aspx?FamilyID=bb3ad767-5f69-4db9-b1c9-8f55759846ed&amp;displaylang=en">GDR R2</a>. You don’t need any additional licenses for that. </li>    <li>Import the schema and configuration of your database using a Database Project. </li>    <li><a href="http://msdn.microsoft.com/en-us/library/dd193409.aspx">Configure</a> your database project so that a specific database is linked to a specific solution configuration. For instance, a local build should deploy your database to your local development PC, while the Daily Build should deploy it to a central database server. </li>    <li>Add a dedicated AfterDropBuild target to the build.proj of your Build Definition to build and deploy the database project to the configured database: </li> </ul>  <blockquote><span style="font-family: courier new; font-size: x-small">&lt;Target Name=&quot;AfterDropBuild&quot;&gt;</span>     <br /><span style="font-family: courier new; font-size: x-small">&lt;MSBuild Projects=&quot;$(SolutionRoot)\Main\Source\ConstructIT\Database\Database.dbproj&quot; Properties=&quot; OutDir=$(OutDir)&quot; Targets=&quot;Deploy&quot;/&gt;</span>     <br /><span style="font-family: courier new; font-size: x-small">&lt;/Target&gt;</span></blockquote>  <ul>   <li>For more information on database deployment using Visual Studio 2008, read the Gert Drapers’ <a href="http://blogs.msdn.com/b/gertd/">blog</a>. </li>    <li>This also works with the Team Build 2010’s Upgrade Template, but if you want to do this with the Default Template, follow the steps in this <a href="http://www.codewrecks.com/blog/index.php/2010/01/04/deploy-a-database-project-with-tfs-build-2010/">post</a>. </li> </ul> Other tips and suggestions   <br />  <ul>   <li>Make an arrangement with your team that the first on entering the office in the morning will be responsible for checking the build status, and if one of them failed, fixing the problem(s). </li>    <li>Write down any important details around the build (such as common problems, details on every build, etc) on your project or department site, and make sure there is more than one team member who knows how to customize or adapt the build. </li>    <li>Use the Build Notification tool part of the <a href="http://msdn.microsoft.com/en-us/teamsystem/bb980963.aspx#build">TFS Power Tools</a> to keep an eye on the build through its corresponding icon on the Windows Task Bar. </li>    <li>You can tweak a Team Build 2008 Build Definition (or a 2010 Upgrade Template) using the many properties mentioned on <a href="http://blogs.msdn.com/aaronhallberg/archive/2008/02/12/team-build-2008-property-reference.aspx">this site</a>. </li>    <li>Most of the guidance is intended for Team Build 2008, but will work just as well on a <a href="http://msdn.microsoft.com/en-us/library/dd647553.aspx">Team Build 2010 Upgrade Template</a>. However, if you want to find out how to get the most out of the workflow-based Default Template, check out this <a href="http://www.ewaldhofman.nl/category/Team-Build.aspx">series of posts</a> written by MVP <a href="http://www.ewaldhofman.nl/category/Team-Build.aspx">Ewald Hofman</a>. </li> </ul>  