---
layout: post
title: The curious case of a deadlock in Autofac
date: '2015-01-14T19:42:00.001+01:00'
author: Dennis Doomen
tags:
- autofac
- threading
modified_time: '2015-01-14T19:58:22.123+01:00'
blogger_id: tag:blogger.com,1999:blog-15137028.post-9062010288844146728
blogger_orig_url: http://www.continuousimprover.com/2015/01/the-curious-case-of-deadlock-in-autofac.html
---

<p>It has been <a href="http://www.continuousimprover.com/2011_09_01_archive.html">more than two years</a> since we switched from Microsoft Unity to <a href="http://autofac.org/">Autofac</a> and we haven't regretted this a single day. Not only is the resolution performance much better than Unity, but it’s the feature set, in particular the <a href="http://autofac.readthedocs.org/en/latest/resolve/relationships.html">relation types</a>, that makes a world of difference. In terms of concurrency, there's not much to think about it. Autofac's concurrency model has been designed to be thread-safe from the ground up. In fact, there's only a single scenario in where you have to be careful what you do. And that's exactly where we went wrong…  <p>The case this post is about involves the <strong>ContainerBuilder</strong>'s fancy factory registration API. Consider the following statement.  <div id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:9d23a59e-6493-4090-8cef-71be58d93cad" class="wlWriterEditableSmartContent" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px"><pre style=" width: 770px; height: 42px;background-color:White;overflow: auto;;font-family:Courier New;font-size:9.75"><div><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="color: #008080;">1</span> <span style="color: #000000;">var builder </span><span style="color: #000000;">=</span><span style="color: #000000;"> </span><span style="color: #0000FF;">new</span><span style="color: #000000;"> ContainerBuilder(); <br /></span><span style="color: #008080;">2</span> <span style="color: #000000;">builder.Register</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">IQueryProcessor</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(ctx </span><span style="color: #000000;">=&gt;</span><span style="color: #000000;"> </span><span style="color: #0000FF;">new</span><span style="color: #000000;"> QueryProcessor()).SingleInstance();</span></div></pre><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>This tells Autofac that every time my code needs an instance of <strong>IQueryProcessor</strong> (either through a constructor or property dependency or through an explicit call to <strong>Resolve</strong>), it should return the same instance of <strong>QueryProcessor</strong> initialized with a particular storage option. So far so good, but imagine that my <strong>QueryProcessor</strong> class has a dependency on the imaginary <strong>ICachingStrategy</strong> abstraction that has been registered upfront. I can change my registration to this.<br /><div id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:d0b15f50-ba19-43da-b0dd-34c968d24745" class="wlWriterEditableSmartContent" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px"><pre style=" width: 770px; height: 42px;background-color:White;overflow: auto;;font-family:Courier New;font-size:9.75"><div><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="color: #008080;">1</span> <span style="color: #000000;">builder.Register</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">IQueryProcessor</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(ctx </span><span style="color: #000000;">=&gt;</span><span style="color: #000000;"> <br /></span><span style="color: #008080;">2</span> <span style="color: #000000;">    </span><span style="color: #0000FF;">new</span><span style="color: #000000;"> QueryProcessor(ctx.Resolve</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">ICachingStrategy</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">())).SingleInstance(); </span></div></pre><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>The <strong>ctx</strong> variable gives me access to the container so that I can resolve any other dependencies from it. If you carefully read the <a href="http://autofac.readthedocs.org/en/latest/advanced/concurrency.html">concurrency</a> section of Autofac's wiki, you'll notice that this <strong>ctx</strong> variable represents a temporary copy of the actual container. In other words, this container is only available during the invocation of the lambda expression. And that's exactly how Autofac manages to be so thread-safe. Any locking that would normally happen in the global container now happens in a local temporary container and will not affect any other resolutions, nor prevent reentrance.<br><br>Considering this temporary nature, the following might be very dangerous.<br /><div id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:13f67077-bc8f-47bf-93ea-43ce8ead2065" class="wlWriterEditableSmartContent" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px"><pre style=" width: 770px; height: 24px;background-color:White;overflow: auto;;font-family:Courier New;font-size:9.75"><div><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="color: #008080;">1</span> <span style="color: #000000;">builder.Register</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">IQueryProcessor</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(ctx </span><span style="color: #000000;">=&gt;</span><span style="color: #000000;"> </span><span style="color: #0000FF;">new</span><span style="color: #000000;"> QueryProcessor(ctx).SingleInstance(); </span></div></pre><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>Notice that I'm passing the <strong>ctx</strong> variable into the constructor. Now, it highly depends on what the constructor is doing here, but assume for now that it is storing that container reference in a private field and using that to resolve other dependencies at a much later stage. Didn't I just mention that we're dealing with a temporary container? Indeed. It's very likely that that resolution attempt will blow up in your face! So how do you fix this? Like this:<br /><div id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:001d5cc4-3586-4535-8d7f-9f7311da422c" class="wlWriterEditableSmartContent" style="float: none; padding-bottom: 0px; padding-top: 0px; padding-left: 0px; margin: 0px; display: inline; padding-right: 0px"><pre style=" width: 770px; height: 46px;background-color:White;overflow: auto;;font-family:Courier New;font-size:9.75"><div><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="color: #008080;">1</span> <span style="color: #000000;">builder.Register</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">IQueryProcessor</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">(ctx </span><span style="color: #000000;">=&gt;</span><span style="color: #000000;"> <br /></span><span style="color: #008080;">2</span> <span style="color: #000000;">    </span><span style="color: #0000FF;">new</span><span style="color: #000000;"> QueryProcessor(ctx.Resolve</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">IComponentContext</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">()).SingleInstance(); </span></div></pre><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>Resolving the <strong>IComponentContext</strong> (Autofac's abstraction for a container) returns the actual <a href="http://nblumhardt.com/2011/01/an-autofac-lifetime-primer/">global</a> container that you can safely use at a later point of time. So to summarize, use the temporary container for resolving dependencies needed at construction time, but use the global container to resolve any run-time dependencies. Guess what we did wrong…. <br><br>So what are your experiences with Autofac? Share them here or let me know by tweeting me at <a href="https://twitter.com/ddoomen">@ddoomen</a>. </p>  