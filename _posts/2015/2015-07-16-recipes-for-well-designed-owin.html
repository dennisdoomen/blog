---

title: Ingredients for well-designed OWIN middleware components - Part 1
date: '2015-07-16T09:07:00.002+02:00'

tags:
- OWIN Recipes
modified_time: '2015-10-09T10:08:48.188+02:00'
blogger_id: tag:blogger.com,1999:blog-15137028.post-6128155861523649622
blogger_orig_url: http://www.continuousimprover.com/2015/07/recipes-for-well-designed-owin.html
---

<div style="margin: 0in;"><span style="font-family: inherit;">My main focus the last couple of months has been on building components that offer HTTP-based services. This whole component-oriented focus is something we've been focusing on the last year or so because we wanted to actively trying move away from building monolithic systems. Tools like OWIN, NuGet and ILMerge have enabled new ways of building .NET software at scale that we're trying to benefit from. This series of posts intends to list some of the practices that emerged from building those components.</span></div><br /><div style="margin: 0in;"><span style="font-family: inherit;">To prevent ending up with a theoretical discussion, I've build an accompanying example project called </span><a href="https://github.com/dennisdoomen/piercer" style="font-family: inherit;">Piercer</a><span style="font-family: inherit;">. Piercer is a little OWIN middleware component that you can host in your OWIN-aware console application, Windows Service or IIS-based web site. It exposes an end-point at route api/piercer/assemblies that lists the run-time assemblies in the </span><span style="font-family: Courier New, Courier, monospace;">AppDomain </span><span style="font-family: inherit;">as well as their version and culture. For the sake of this post, its functionality is mostly irrelevant. Itâ€™s the mechanism of how it has been build that is important for this discussion.</span></div><div style="margin: 0in;"><span style="font-family: inherit;"><br /></span></div><div style="margin: 0in;"><span style="font-weight: bold;"><span style="font-family: inherit;">Ingredient 1: Setup your middleware using the UseXXX convention</span></span></div><div style="margin: 0in;"><span style="font-family: inherit;">It's not an official requirement, but almost all middleware components are added to an OWIN pipeline builder using a extension method on </span><span style="font-family: Courier New, Courier, monospace;">IAppBuilder </span><span style="font-family: inherit;">that starts with </span><span style="font-family: Courier New, Courier, monospace;">Use</span><span style="font-family: inherit;">. And if you want to allow developers to configure your component, let them pass in a settings class as well. </span></div><div style="margin: 0in;"><br /></div><div style="margin: 0in 0in 0in 0.375in;"><span style="font-family: Courier New, Courier, monospace;">var appBuilder = new AppBuilder();</span></div><div style="margin: 0in 0in 0in 0.375in;"><span style="font-family: Courier New, Courier, monospace;">appBuilder.UsePiercer(new PiercerSettings().Ignoring("Piercer.Middleware"));</span></div><div style="margin: 0in;"><br /></div><div style="margin: 0in;"></div>Following those conventions makes your component more approachable. I myself prefer a fluent API for the settings, but whether you want to adopt that is up to you. <br /><div><br /></div><b>Ingredient 2: Minimize public dependencies </b><br />The most painful experience you can give to the consumers of your middleware component is the one where adding the NuGet package involves including several other NuGet packages as well. It gets worse if that consumer is already depending on other packages that on turn depend on different versions of those same packages. Avoiding this so-called <a href="http://blogs.msdn.com/b/eric_brechner/archive/2015/07/01/diamond-dependencies.aspx">diamond dependency problem</a> is crucial to a successful component. <br /><br />One of the most effective ways of solving that problem is to internalize the assemblies your component depends on and which are not exposed through your public API. Both <a href="https://www.nuget.org/packages/ilmerge">ILMerge</a>, which has been discontinued by Microsoft, and <a href="https://github.com/gluck/il-repack">ILRepack</a>, the open-source replacement for the first, can do the job. You'll have to experiment with which one works best unfortunately. Neither of them are the silver bullet to merging assemblies. I've been successful in using the ILRepack in one project, but it failed in the other. It requires a little bit of trial-and-error to get it right. But if you do, you'll make consuming your component almost painless. In the Piercer project, I've used the following PowerShell snippet to get all its dependencies merged into a single assembly like this:  <br /><div style="font-family: Calibri; font-size: 11.0pt; margin: 0in;"><br /></div><div lang="nl" style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">&nbsp;&nbsp;&nbsp; Merge-Assemblies `</span></div><div lang="nl" style="margin: 0in 0in 0in 0.75in;"><span style="font-family: Courier New, Courier, monospace;">-outputFile "$NugetOutputDir\Piercer.Middleware.dll"`</span></div><div lang="nl" style="margin: 0in 0in 0in 0.75in;"><span style="font-family: Courier New, Courier, monospace;">-libPaths @( </span></div><div lang="nl" style="margin: 0in 0in 0in 1.125in;"><span style="font-family: Courier New, Courier, monospace;">"$BaseDirectory\packages\Microsoft.AspNet.WebApi.Core.5.2.3\lib\net45",</span></div><div lang="nl" style="margin: 0in 0in 0in 1.125in;"><span style="font-family: Courier New, Courier, monospace;">"$BaseDirectory\packages\Newtonsoft.Json.6.0.4\lib\net45\"</span></div><div lang="nl" style="margin: 0in 0in 0in 0.75in;"><span style="font-family: Courier New, Courier, monospace;">)`</span></div><div lang="nl" style="margin: 0in 0in 0in 0.75in;"><span style="font-family: Courier New, Courier, monospace;">-files @(</span></div><div lang="nl" style="margin: 0in 0in 0in 0.75in;"><span style="font-family: Courier New, Courier, monospace;">"$SrcDir\Piercer.Middleware\bin\release\Piercer.Middleware.dll",</span></div><div lang="nl" style="margin: 0in 0in 0in 0.75in;"><span style="font-family: Courier New, Courier, monospace;">"$SrcDir\Piercer.Middleware\bin\release\Microsoft.Owin.dll",</span></div><div lang="nl" style="margin: 0in 0in 0in 0.75in;"><span style="font-family: Courier New, Courier, monospace;">"$SrcDir\Piercer.Middleware\bin\release\Newtonsoft.Json.dll",</span></div><div lang="nl" style="margin: 0in 0in 0in 0.75in;"><span style="font-family: Courier New, Courier, monospace;">"$SrcDir\Piercer.Middleware\bin\release\Swashbuckle.Core.dll",</span></div><div lang="nl" style="margin: 0in 0in 0in 0.75in;"><span style="font-family: Courier New, Courier, monospace;">"$SrcDir\Piercer.Middleware\bin\release\System.Net.Http.Formatting.dll",</span></div><div lang="nl" style="margin: 0in 0in 0in 0.75in;"><span style="font-family: Courier New, Courier, monospace;">"$SrcDir\Piercer.Middleware\bin\release\System.Web.Http.dll",</span></div><div lang="nl" style="margin: 0in 0in 0in 0.75in;"><span style="font-family: Courier New, Courier, monospace;">"$SrcDir\Piercer.Middleware\bin\release\System.Web.Http.Owin.dll",</span></div><div lang="nl" style="margin: 0in 0in 0in 0.75in;"><span style="font-family: Courier New, Courier, monospace;">"$SrcDir\Piercer.Middleware\bin\release\System.Web.Http.WebHost.dll",</span></div><div lang="nl" style="margin: 0in 0in 0in 0.75in;"><span style="font-family: Courier New, Courier, monospace;">"$SrcDir\Piercer.Middleware\bin\release\Autofac.dll",</span></div><div lang="nl" style="margin: 0in 0in 0in 0.75in;"><span style="font-family: Courier New, Courier, monospace;">"$SrcDir\Piercer.Middleware\bin\release\Autofac.Integration.WebAPI.dll"</span></div><div lang="nl" style="margin: 0in 0in 0in 0.375in;"><span style="font-family: Courier New, Courier, monospace;">)</span></div><div style="font-family: Calibri; font-size: 11.0pt; margin: 0in;"><br /></div><div style="font-family: Calibri; font-size: 11.0pt; margin: 0in;">The Merge-Assemblies function is a little wrapper that invokes ILRepack with the right arguments. You can find its definition <a href="https://github.com/dennisdoomen/piercer/blob/master/Build/default.ps1#L136">here</a>.&nbsp;</div>