---

title: Continuous refactoring in its natural habitat
date: '2015-02-01T15:59:00.000+01:00'

tags: 
modified_time: '2015-02-01T16:46:20.289+01:00'
thumbnail: http://lh6.ggpht.com/-qtDQqCwQxAY/VM4_UPPLN9I/AAAAAAAAKL0/fBFvrnPmp2s/s72-c/clip_image001_thumb%25255B4%25255D.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-15137028.post-7228994466418020451
blogger_orig_url: http://www.continuousimprover.com/2015/02/continuous-refactoring-in-its-natural.html
---

So over the last three weeks or so, after the kids went to bed, I've been working on some new features for <a href="http://www.fluentassertions.com/">Fluent Assertions</a> . While doing so I went off track several times in an attempt to improve several API's and internal designs that didn't felt quite right. Since this thought process is representative for the way I approach professional software development and my blog is about continuous improvement I decided to try converting my brain's thought process in a post. <br />Before I go into the deep, let me share some context for the problem at hand. Fluent Assertions (let's call it FA from now) has an API to compare two object graphs which internally uses a collection of implementations of the <strong>IEquivalencyStep</strong> interface. As part of the next release, I wanted to allow people to directly affect the API's behavior by adding, removing or replacing steps with their own. Before that change, the <strong>EquivalencyValidater</strong> class had a method <strong>GetSteps</strong> to provide it with the out-of-the-box equivalency steps.<br /><div class="wlWriterEditableSmartContent" id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:9657d418-8645-479d-a18e-91e35984cdcc" style="display: inline; float: none; margin: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><pre style="background-color: white; font-family: Tahoma; font-size: 8,25; height: 321px; overflow: auto; width: 770px;"><div><br /><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="color: blue;">private</span><span style="color: black;"> IEnumerable</span><span style="color: black;">&lt;</span><span style="color: black;">IEquivalencyStep</span><span style="color: black;">&gt;</span><span style="color: black;"> GetSteps()<br />{<br />    </span><span style="color: blue;">yield</span><span style="color: black;"> </span><span style="color: blue;">return</span><span style="color: black;"> </span><span style="color: blue;">new</span><span style="color: black;"> TryConversionEquivalencyStep();<br />    </span><span style="color: blue;">yield</span><span style="color: black;"> </span><span style="color: blue;">return</span><span style="color: black;"> </span><span style="color: blue;">new</span><span style="color: black;"> ReferenceEqualityEquivalencyStep();<br />    </span><span style="color: blue;">yield</span><span style="color: black;"> </span><span style="color: blue;">return</span><span style="color: black;"> </span><span style="color: blue;">new</span><span style="color: black;"> RunAllUserStepsEquivalencyStep();<br />    </span><span style="color: blue;">yield</span><span style="color: black;"> </span><span style="color: blue;">return</span><span style="color: black;"> </span><span style="color: blue;">new</span><span style="color: black;"> GenericDictionaryEquivalencyStep();<br />    </span><span style="color: blue;">yield</span><span style="color: black;"> </span><span style="color: blue;">return</span><span style="color: black;"> </span><span style="color: blue;">new</span><span style="color: black;"> DictionaryEquivalencyStep();<br />    </span><span style="color: blue;">yield</span><span style="color: black;"> </span><span style="color: blue;">return</span><span style="color: black;"> </span><span style="color: blue;">new</span><span style="color: black;"> GenericEnumerableEquivalencyStep();<br />    </span><span style="color: blue;">yield</span><span style="color: black;"> </span><span style="color: blue;">return</span><span style="color: black;"> </span><span style="color: blue;">new</span><span style="color: black;"> EnumerableEquivalencyStep();<br />    </span><span style="color: blue;">yield</span><span style="color: black;"> </span><span style="color: blue;">return</span><span style="color: black;"> </span><span style="color: blue;">new</span><span style="color: black;"> StringEqualityEquivalencyStep();<br />    </span><span style="color: blue;">yield</span><span style="color: black;"> </span><span style="color: blue;">return</span><span style="color: black;"> </span><span style="color: blue;">new</span><span style="color: black;"> SystemTypeEquivalencyStep();<br />    </span><span style="color: blue;">yield</span><span style="color: black;"> </span><span style="color: blue;">return</span><span style="color: black;"> </span><span style="color: blue;">new</span><span style="color: black;"> EnumEqualityStep();<br />    </span><span style="color: blue;">yield</span><span style="color: black;"> </span><span style="color: blue;">return</span><span style="color: black;"> </span><span style="color: blue;">new</span><span style="color: black;"> StructuralEqualityEquivalencyStep();<br />    </span><span style="color: blue;">yield</span><span style="color: black;"> </span><span style="color: blue;">return</span><span style="color: black;"> </span><span style="color: blue;">new</span><span style="color: black;"> SimpleEqualityEquivalencyStep();<br />}</span></div><br /></pre><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>So I started to move those defaults into a new static <strong>AssertionOptions</strong> class. Yes, I know, it's static, but it's supposed to be global and should affect all usages of FA.<br /><div class="wlWriterEditableSmartContent" id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:ce477e29-6062-489c-af05-5ffa4753f3bc" style="display: inline; float: none; margin: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><pre style="background-color: white; font-family: Tahoma; font-size: 9,75; height: 348px; overflow: auto; width: 770px;"><div><br /><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="color: blue;">public</span><span style="color: black;"> </span><span style="color: blue;">static</span><span style="color: black;"> </span><span style="color: blue;">class</span><span style="color: black;"> AssertionOptions<br />{<br />    </span><span style="color: blue;">private</span><span style="color: black;"> </span><span style="color: blue;">static</span><span style="color: black;"> List</span><span style="color: black;">&lt;</span><span style="color: black;">IEquivalencyStep</span><span style="color: black;">&gt;</span><span style="color: black;"> steps </span><span style="color: black;">=</span><span style="color: black;"> </span><span style="color: blue;">new</span><span style="color: black;"> List</span><span style="color: black;">&lt;</span><span style="color: black;">IEquivalencyStep</span><span style="color: black;">&gt;</span><span style="color: black;">();<br /><br />    </span><span style="color: blue;">static</span><span style="color: black;"> AssertionOptions()<br />    {<br />        steps.AddRange(GetDefaultSteps());<br />    }<br /><br />    </span><span style="color: blue;">private</span><span style="color: black;"> </span><span style="color: blue;">static</span><span style="color: black;"> IEnumerable</span><span style="color: black;">&lt;</span><span style="color: black;">IEquivalencyStep</span><span style="color: black;">&gt;</span><span style="color: black;"> GetDefaultSteps()<br />    {<br />        </span><span style="color: blue;">yield</span><span style="color: black;"> </span><span style="color: blue;">return</span><span style="color: black;"> </span><span style="color: blue;">new</span><span style="color: black;"> TryConversionEquivalencyStep();<br />        </span><span style="color: blue;">yield</span><span style="color: black;"> </span><span style="color: blue;">return</span><span style="color: black;"> </span><span style="color: blue;">new</span><span style="color: black;"> ReferenceEqualityEquivalencyStep();<br />        </span><span style="color: green;">//</span><span style="color: green;"> â€¦left out for brevity</span><span style="color: green;"><br /></span><span style="color: black;">    }<br />}</span></div><br /></pre></div><h2>Practicing object-oriented design</h2>But then my obsession about maintainable code kicked in. Why would I overload the <strong>AssertionOptions</strong> class with the responsibilities and knowledge on where to insert new steps in relation to the built-in steps? So let's apply rule 4 of <a href="http://www.slideshare.net/dennisdoomen/object-calisthenetics">Object Calisthenics</a> which is also known as First Class Collections:<br /><br />Any class that contains a collection should contain no other member variables. If you have a set of elements and want to manipulate them, create a class that is dedicated for this set.<br /><br />I cannot stress this enough. Whenever your class contains multiple private fields, please consider extracting those in dedicate collection classes or value types. It might feel as unnecessary refactoring, but it's really going to make your code mode object-oriented and maintainable. Regardless, after refactoring all this logic ended up in a new <strong>EquivalencyStepCollection</strong> that is used like this:<br /><div class="wlWriterEditableSmartContent" id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:53b61afa-faf4-469b-beb8-4af5650c66f7" style="display: inline; float: none; margin: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><pre style="background-color: white; font-family: Tahoma; font-size: 9,75; height: 242px; overflow: auto; width: 770px;"><div><br /><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="color: blue;">public</span><span style="color: black;"> </span><span style="color: blue;">static</span><span style="color: black;"> </span><span style="color: blue;">class</span><span style="color: black;"> AssertionOptions<br />{<br />    </span><span style="color: blue;">private</span><span style="color: black;"> </span><span style="color: blue;">static</span><span style="color: black;"> EquivalencyAssertionOptions defaults </span><span style="color: black;">=</span><span style="color: black;"> </span><span style="color: blue;">new</span><span style="color: black;"> EquivalencyAssertionOptions();<br /><br />    </span><span style="color: blue;">static</span><span style="color: black;"> AssertionOptions()<br />    {<br />        EquivalencySteps </span><span style="color: black;">=</span><span style="color: black;"> </span><span style="color: blue;">new</span><span style="color: black;"> EquivalencyStepCollection(GetDefaultSteps());<br />    }<br /><br />    </span><span style="color: blue;">public</span><span style="color: black;"> </span><span style="color: blue;">static</span><span style="color: black;"> EquivalencyStepCollection EquivalencySteps { </span><span style="color: blue;">get</span><span style="color: black;">; </span><span style="color: blue;">private</span><span style="color: black;"> </span><span style="color: blue;">set</span><span style="color: black;">; }<br />}</span></div><br /></pre></div>The collection class really behaves as a collection and implements, at a minimum, <strong>IEnumerable</strong>:<br /><span style="color: blue;">public</span><span style="color: black;"> </span><span style="color: blue;">class</span><span style="color: black;"> EquivalencyStepCollection : IEnumerable</span><span style="color: black;">&lt;</span><span style="color: black;">IEquivalencyStep</span><span style="color: black;">&gt;</span><br /><div class="wlWriterEditableSmartContent" id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:6d29efe9-208a-4e22-8ccf-e4eb70ad56c1" style="display: inline; float: none; margin: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><pre style="background-color: white; font-family: Tahoma; font-size: 9,75; height: 417px; overflow: auto; width: 770px;"><div><br /><span style="color: black;">{<br />    </span><span style="color: blue;">private</span><span style="color: black;"> </span><span style="color: blue;">readonly</span><span style="color: black;"> List</span><span style="color: black;">&lt;</span><span style="color: black;">IEquivalencyStep</span><span style="color: black;">&gt;</span><span style="color: black;"> steps </span><span style="color: black;">=</span><span style="color: black;"> </span><span style="color: blue;">new</span><span style="color: black;"> List</span><span style="color: black;">&lt;</span><span style="color: black;">IEquivalencyStep</span><span style="color: black;">&gt;</span><span style="color: black;">();<br /><br />    </span><span style="color: blue;">public</span><span style="color: black;"> EquivalencyStepCollection(IEnumerable</span><span style="color: black;">&lt;</span><span style="color: black;">IEquivalencyStep</span><span style="color: black;">&gt;</span><span style="color: black;"> defaultSteps)<br />    {<br />        steps.AddRange(defaultSteps);<br />    }<br /><br />    </span><span style="color: blue;">public</span><span style="color: black;"> IEnumerator</span><span style="color: black;">&lt;</span><span style="color: black;">IEquivalencyStep</span><span style="color: black;">&gt;</span><span style="color: black;"> GetEnumerator()<br />    {<br />        </span><span style="color: blue;">return</span><span style="color: black;"> steps.GetEnumerator();<br />    }<br /><br />    IEnumerator IEnumerable.GetEnumerator()<br />    {<br />        </span><span style="color: blue;">return</span><span style="color: black;"> GetEnumerator();<br />    }<br />}</span></div><br /></pre><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>I didn't mention it before, but I wouldn't be taken myself seriously if I would not be practicing <a href="http://www.slideshare.net/dennisdoomen/tdd-and-solid-two-ingredients-for-high-quality-software">Test Driven Development</a>. So one of those tests involves specifying the behavior of adding a step and making sure it ends up just before the built-in step that does a simple comparison using <strong>Object.Equals</strong>:<br /><div class="wlWriterEditableSmartContent" id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:d4e4fc27-244b-4be3-9ad4-56bdfa87fb57" style="display: inline; float: none; margin: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><pre style="background-color: white; font-family: Tahoma; font-size: 9,75; height: 472px; overflow: auto; width: 770px;"><div><br /><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="color: black;">[TestClass]<br /></span><span style="color: blue;">public</span><span style="color: black;"> </span><span style="color: blue;">class</span><span style="color: black;"> When_appending_a_step : Given_temporary_equivalency_steps<br />{<br />    </span><span style="color: blue;">public</span><span style="color: black;"> When_appending_a_step()<br />    {<br />        When(() </span><span style="color: black;">=&gt;</span><span style="color: black;"><br />        {<br />            Steps.Add</span><span style="color: black;">&lt;</span><span style="color: black;">MyEquivalencyStep</span><span style="color: black;">&gt;</span><span style="color: black;">();<br />        });<br />    }<br /><br />    [TestMethod]<br />    </span><span style="color: blue;">public</span><span style="color: black;"> </span><span style="color: blue;">void</span><span style="color: black;"> Then_it_should_precede_the_final_builtin_step()<br />    {<br />        IEquivalencyStep builtinStep </span><span style="color: black;">=</span><span style="color: black;"> Steps.LastOrDefault(s </span><span style="color: black;">=&gt;</span><span style="color: black;"> s </span><span style="color: blue;">is</span><span style="color: black;"> SimpleEqualityEquivalencyStep);<br />        IEquivalencyStep addedStep </span><span style="color: black;">=</span><span style="color: black;"> Steps.LastOrDefault(s </span><span style="color: black;">=&gt;</span><span style="color: black;"> s </span><span style="color: blue;">is</span><span style="color: black;"> MyEquivalencyStep);<br />        </span><span style="color: blue;">int</span><span style="color: black;"> builtinStepIndex </span><span style="color: black;">=</span><span style="color: black;"> Steps.LastIndexOf(builtinStep);<br />        </span><span style="color: blue;">int</span><span style="color: black;"> addedStepIndex </span><span style="color: black;">=</span><span style="color: black;"> Steps.LastIndexOf(addedStep);<br /><br />        addedStepIndex.Should().Be(builtinStepIndex </span><span style="color: black;">-</span><span style="color: black;"> </span><span style="color: purple;">1</span><span style="color: black;">);<br />    }<br />}</span></div><br /></pre></div><h2>Intention-revealing unit tests</h2>Did you notice that I'm hiding some of the complexities needed to reset the static <strong>AssertionOptions</strong> class in a base-class? I'm not in favor of test base-classes, especially because they tend to get misused pretty quickly. But with the help of <a href="https://github.com/Erwinvandervalk/Chill">Chill</a>, a project by <a href="http://www.erwinvandervalk.net/">Erwin van der Valk</a>, I decided to use one anyhow, simply because it helps clarify the intend of my test. I think it was <a href="http://jeremydmiller.com/">Jeremy D. Miller</a> that once said "If it's not important for the unit test, it's very important not to show it" and clearing up after a test is not important to understand the test. This is what the base-class looks like. Notice Chill's <a href="https://github.com/Erwinvandervalk/Chill/blob/develop/Source/Core/Chill.Shared/GivenWhenThen.cs">GivenWhenThen</a> class.<br /><div class="wlWriterEditableSmartContent" id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:03502135-b19a-4664-a591-a763cca7e820" style="display: inline; float: none; margin: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><pre style="background-color: white; font-family: Tahoma; font-size: 9,75; height: 288px; overflow: auto; width: 770px;"><div><br /><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="color: blue;">public</span><span style="color: black;"> </span><span style="color: blue;">class</span><span style="color: black;"> Given_temporary_equivalency_steps : GivenWhenThen<br />{<br />    </span><span style="color: blue;">protected</span><span style="color: black;"> </span><span style="color: blue;">override</span><span style="color: black;"> </span><span style="color: blue;">void</span><span style="color: black;"> Dispose(</span><span style="color: blue;">bool</span><span style="color: black;"> disposing)<br />    {<br />        Steps.Reset();<br />        </span><span style="color: blue;">base</span><span style="color: black;">.Dispose(disposing);<br />    }<br /><br />    </span><span style="color: blue;">protected</span><span style="color: black;"> </span><span style="color: blue;">static</span><span style="color: black;"> EquivalencyStepCollection Steps<br />    {<br />        </span><span style="color: blue;">get</span><span style="color: black;"> { </span><span style="color: blue;">return</span><span style="color: black;"> AssertionOptions.EquivalencySteps; }<br />    }<br />}</span></div><br /></pre></div>Did you also notice the implementation of the <strong>Then_it_should_precede_the_final_builtin_step</strong>? It's basically a copy of the internal implementation of the <strong>Add</strong> method, so I hardly think it is helping on the intention revealing side of my story. I'm sure you'll agree. This is where my code quality obsession kicked in again, so I decided to extend FA with some specialized extension methods that would help me making those tests a bit more intention revealing.<br /><br />But wait! I surely don't want to pollute my current changes with even more refactoring, would I? No, I definitely prefer small commits and a clean and tidy commit history. But switching to another branch without committing those half-finished changes is not going to allow me to start with a clean slate. Sure, I could <a href="http://git-scm.com/docs/git-stash">stash</a> my changes, but that requires me to think of some unique name. And yes, I do have a second clone somewhere on my SSD, but I'd rather create a temporary commit that I can use to rebase on those new assertions at a later point. Well, that's just what Phil Haacked's <a href="http://haacked.com/archive/2014/07/28/github-flow-aliases/"><strong>git save</strong></a> and <strong>git undo</strong> aliases do.<br /><br /><a href="http://lh5.ggpht.com/-7Gxoyajlq1g/VM4_TkRcU3I/AAAAAAAAKLw/G_BZ4TCe5OU/s1600-h/clip_image001%25255B7%25255D.png"><img alt="clip_image001" border="0" src="http://lh6.ggpht.com/-qtDQqCwQxAY/VM4_UPPLN9I/AAAAAAAAKL0/fBFvrnPmp2s/clip_image001_thumb%25255B4%25255D.png?imgmax=800" height="111" style="background-image: none; border-bottom-width: 0px; border-left-width: 0px; border-right-width: 0px; border-top-width: 0px; display: block; float: none; margin-left: auto; margin-right: auto; padding-left: 0px; padding-right: 0px; padding-top: 0px;" title="clip_image001" width="640" /></a> <br />After installing those aliases and executing <strong>git save</strong> from your favorite git bash or PowerShell console (don't forget <a href="http://haacked.com/archive/2011/12/13/better-git-with-powershell.aspx/">Posh-Git</a> if you do) will take the local changes and commit those as a local commit named SAVEPOINT. Now I can safely switch to a new branch (<strong>git cob</strong> does just that) and work on those extensions.<br /><br /><a href="http://lh4.ggpht.com/--shE9EyWvO0/VM4_UaQ0H7I/AAAAAAAAKL8/q6kwY6Plrlk/s1600-h/clip_image002%25255B4%25255D.png"><img alt="clip_image002" border="0" src="http://lh3.ggpht.com/-3QMmCFd6tlI/VM4_U1OpA7I/AAAAAAAAKME/ybyFLTYfZdM/clip_image002_thumb%25255B1%25255D.png?imgmax=800" height="96" style="background-image: none; border-bottom-width: 0px; border-left-width: 0px; border-right-width: 0px; border-top-width: 0px; display: block; float: none; margin-left: auto; margin-right: auto; padding-left: 0px; padding-right: 0px; padding-top: 0px;" title="clip_image002" width="644" /></a> <br />One of the first assertion methods I implemented was the <strong>collection.Should().StartWith()</strong> method. After the first spec representing the happy path it looked like this:<br /><div class="wlWriterEditableSmartContent" id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:6e898b6f-4c94-4e8c-9d43-d3f7f8f40789" style="display: inline; float: none; margin: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><pre style="background-color: white; font-family: Tahoma; font-size: 9,75; height: 222px; overflow: auto; width: 770px;"><div><br /><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="color: blue;">public</span><span style="color: black;"> AndConstraint</span><span style="color: black;">&lt;</span><span style="color: black;">TAssertions</span><span style="color: black;">&gt;</span><span style="color: black;"> StartWith(</span><span style="color: blue;">object</span><span style="color: black;"> element, </span><span style="color: blue;">string</span><span style="color: black;"> because </span><span style="color: black;">=</span><span style="color: black;"> </span><span style="color: maroon;">""</span><span style="color: black;">, </span><span style="color: blue;">params</span><span style="color: black;"> </span><span style="color: blue;">object</span><span style="color: black;">[] becauseArgs)<br />{<br />        </span><span style="color: blue;">object</span><span style="color: black;"> first </span><span style="color: black;">=</span><span style="color: black;"> Subject.Cast</span><span style="color: black;">&lt;</span><span style="color: blue;">object</span><span style="color: black;">&gt;</span><span style="color: black;">().FirstOrDefault();<br /><br />        Execute.Assertion<br />            .ForCondition(first.IsSameOrEqualTo(element))<br />            .BecauseOf(because, becauseArgs)<br />            .FailWith(</span><span style="color: maroon;">"</span><span style="color: maroon;">Expected {context:collection} to start with {0}{reason}, but found {1}.</span><span style="color: maroon;">"</span><span style="color: black;">, element, first);<br />            </span><span style="color: blue;">return</span><span style="color: black;"> </span><span style="color: blue;">new</span><span style="color: black;"> AndConstraint</span><span style="color: black;">&lt;</span><span style="color: black;">TAssertions</span><span style="color: black;">&gt;</span><span style="color: black;">((TAssertions) </span><span style="color: blue;">this</span><span style="color: black;">);<br />}</span></div><br /></pre></div><h2>Finding a better assertion API</h2>But after finishing all the other paths as part of me practicing TDD, it ended up like this.<br /><div class="wlWriterEditableSmartContent" id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:51638178-7119-4530-80b6-6ace8aa73bfb" style="display: inline; float: none; margin: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><pre style="background-color: white; font-family: Tahoma; font-size: 9,75; height: 580px; overflow: auto; width: 770px;"><div><br /><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="color: blue;">public</span><span style="color: black;"> AndConstraint</span><span style="color: black;">&lt;</span><span style="color: black;">TAssertions</span><span style="color: black;">&gt;</span><span style="color: black;"> StartWith(</span><span style="color: blue;">object</span><span style="color: black;"> element, </span><span style="color: blue;">string</span><span style="color: black;"> because </span><span style="color: black;">=</span><span style="color: black;"> </span><span style="color: maroon;">""</span><span style="color: black;">, </span><span style="color: blue;">params</span><span style="color: black;"> </span><span style="color: blue;">object</span><span style="color: black;">[] becauseArgs)<br />{<br />    </span><span style="color: blue;">bool</span><span style="color: black;"> succeeded </span><span style="color: black;">=</span><span style="color: black;"> Execute.Assertion<br />        .ForCondition(</span><span style="color: black;">!</span><span style="color: black;">ReferenceEquals(Subject, </span><span style="color: blue;">null</span><span style="color: black;">))<br />        .BecauseOf(because, becauseArgs)<br />        .FailWith(</span><span style="color: maroon;">"</span><span style="color: maroon;">Expected {context:collection} to start with {0}{reason}, but the collection is {1}.</span><span style="color: maroon;">"</span><span style="color: black;">, element, </span><span style="color: blue;">null</span><span style="color: black;">);<br /><br />    </span><span style="color: blue;">if</span><span style="color: black;"> (succeeded)<br />    {<br />        succeeded </span><span style="color: black;">=</span><span style="color: black;"> Execute.Assertion<br />            .ForCondition(Subject.Cast</span><span style="color: black;">&lt;</span><span style="color: blue;">object</span><span style="color: black;">&gt;</span><span style="color: black;">().Any())<br />            .BecauseOf(because, becauseArgs)<br />            .FailWith(</span><span style="color: maroon;">"</span><span style="color: maroon;">Expected {context:collection} to start with {0}{reason}, but the collection is empty.</span><span style="color: maroon;">"</span><span style="color: black;">, element);<br />    }<br /><br />    </span><span style="color: blue;">if</span><span style="color: black;"> (succeeded)<br />    {<br />        </span><span style="color: blue;">object</span><span style="color: black;"> first </span><span style="color: black;">=</span><span style="color: black;"> Subject.Cast</span><span style="color: black;">&lt;</span><span style="color: blue;">object</span><span style="color: black;">&gt;</span><span style="color: black;">().FirstOrDefault();<br /><br />        Execute.Assertion<br />            .ForCondition(first.IsSameOrEqualTo(element))<br />            .BecauseOf(because, becauseArgs)<br />            .FailWith(</span><span style="color: maroon;">"</span><span style="color: maroon;">Expected {context:collection} to start with {0}{reason}, but found {1}.</span><span style="color: maroon;">"</span><span style="color: black;">, element, first);<br />    }<br /><br />    </span><span style="color: blue;">return</span><span style="color: black;"> </span><span style="color: blue;">new</span><span style="color: black;"> AndConstraint</span><span style="color: black;">&lt;</span><span style="color: black;">TAssertions</span><span style="color: black;">&gt;</span><span style="color: black;">((TAssertions) </span><span style="color: blue;">this</span><span style="color: black;">);<br />}</span></div><br /></pre></div>This implementation is quite representative for most of the other extension methods in FA, but somehow it didn't feel right. I was planning to include <strong>EndWidth</strong> and <strong>HaveElementPreceding</strong> as well, but I wasn't looking forward to more of these monstrosities. In particular the constructs with the succeeded variable don't help understanding the code. You might expect <strong>FailWith</strong> to throw some kind of exception when the condition is not met, and usual it does. But the structural equivalency API uses an <strong>AssertionScope</strong> to collect all assertion failures and will throw them as one failure at the end. In fact, anybody can build extensions to FA and use the <strong>AssertionScope</strong> in some more advanced scenarios.<br /><br />Anyway, I decided to commit those changes and give myself a couple of days to come up with a better approach. I already knew I was going to create some kind of fluent API, but I needed a bit of time to chew on it. This is what I ended up with:<br /><div class="wlWriterEditableSmartContent" id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:571aaeee-0719-4485-aeca-fd7c0b01955b" style="display: inline; float: none; margin: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><pre style="background-color: white; font-family: Tahoma; font-size: 9,75; height: 387px; overflow: auto; width: 770px;"><div><br /><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="color: blue;">public</span><span style="color: black;"> AndConstraint</span><span style="color: black;">&lt;</span><span style="color: black;">TAssertions</span><span style="color: black;">&gt;</span><span style="color: black;"> StartWith(</span><span style="color: blue;">object</span><span style="color: black;"> element, </span><span style="color: blue;">string</span><span style="color: black;"> because </span><span style="color: black;">=</span><span style="color: black;"> </span><span style="color: maroon;">""</span><span style="color: black;">, </span><span style="color: blue;">params</span><span style="color: black;"> </span><span style="color: blue;">object</span><span style="color: black;">[] becauseArgs)<br />{<br />    Execute.Assertion<br />        .BecauseOf(because, becauseArgs)<br />        .WithExpectation(</span><span style="color: maroon;">"</span><span style="color: maroon;">Expected {context:collection} to start with {0}{reason}, </span><span style="color: maroon;">"</span><span style="color: black;">, element)<br />        .ForCondition(</span><span style="color: black;">!</span><span style="color: black;">ReferenceEquals(Subject, </span><span style="color: blue;">null</span><span style="color: black;">))<br />        .FailWith(</span><span style="color: maroon;">"</span><span style="color: maroon;">but the collection is {0}.</span><span style="color: maroon;">"</span><span style="color: black;">, (</span><span style="color: blue;">object</span><span style="color: black;">)</span><span style="color: blue;">null</span><span style="color: black;">)<br />        .Then<br />        .Given(() </span><span style="color: black;">=&gt;</span><span style="color: black;"> Subject.Cast</span><span style="color: black;">&lt;</span><span style="color: blue;">object</span><span style="color: black;">&gt;</span><span style="color: black;">())<br />        .ForCondition(subject </span><span style="color: black;">=&gt;</span><span style="color: black;"> subject.Any())<br />        .FailWith(</span><span style="color: maroon;">"</span><span style="color: maroon;">but the collection is empty.</span><span style="color: maroon;">"</span><span style="color: black;">)<br />        .Then<br />        .Given(objects </span><span style="color: black;">=&gt;</span><span style="color: black;"> objects.FirstOrDefault())<br />        .ForCondition(first </span><span style="color: black;">=&gt;</span><span style="color: black;"> first.IsSameOrEqualTo(element))<br />        .FailWith(</span><span style="color: maroon;">"</span><span style="color: maroon;">but found {0}.</span><span style="color: maroon;">"</span><span style="color: black;">, first </span><span style="color: black;">=&gt;</span><span style="color: black;"> first);<br /><br />    </span><span style="color: blue;">return</span><span style="color: black;"> </span><span style="color: blue;">new</span><span style="color: black;"> AndConstraint</span><span style="color: black;">&lt;</span><span style="color: black;">TAssertions</span><span style="color: black;">&gt;</span><span style="color: black;">((TAssertions) </span><span style="color: blue;">this</span><span style="color: black;">);<br />}</span></div><br /></pre><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --></div>What's important to know is that the <strong>Given</strong> and <strong>Then</strong> members are not even invoked if the previous condition was not met. Granted, it's more than my <a href="https://github.com/dennisdoomen/csharpguidelines/blob/master/Guidelines/1500_MaintainabilityGuidelines.md#methods-should-not-exceed-7-statements-av1500-">typical maximum of 7 statements</a>, but it allowed me to get rid of those intermediate boolean variables and prevent repeating the expectation message. And with that, implementing the other extension methods became pretty easy.<br /><h2>Getting back on track </h2>So, after committing those changes back to develop, my main development branch (I'm using the <a href="http://nvie.com/posts/a-successful-git-branching-model/">Gitflow</a> branching strategy), it was time to back-track to the global <strong>AssertionOptions</strong> API I began this post with. I started that work on a separate branch which head now pointed to the temporary commit I created using <strong>git save</strong>. To get my working directory to the state it was before I side-tracked, but including the new extension methods was just a matter of doing a <strong>git pull develop --rebase</strong> to replay the changes on my feature branch on top of develop, followed by <strong>git undo</strong> to restore my work-in-progress from that temporary commit. I don't understand how I managed to get anything done without those <a href="http://haacked.com/archive/2014/07/28/github-flow-aliases/">aliases</a>.<br /><br />Anyway, this is one of those final unit tests.<br /><div class="wlWriterEditableSmartContent" id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:7067c986-b512-465d-8eac-e3fb37180d05" style="display: inline; float: none; margin: 0px; padding-bottom: 0px; padding-left: 0px; padding-right: 0px; padding-top: 0px;"><pre style="background-color: white; font-family: Tahoma; font-size: 9,75; height: 434px; overflow: auto; width: 770px;"><div><br /><span style="color: blue;">public</span><span style="color: black;"> </span><span style="color: blue;">class</span><span style="color: black;"> When_appending_a_step : Given_temporary_equivalency_steps</span><br /><span style="color: black;">{<br />    </span><span style="color: blue;">public</span><span style="color: black;"> When_appending_a_step()<br />    {<br />        When(() </span><span style="color: black;">=&gt;</span><span style="color: black;"><br />        {<br />            Steps.Add</span><span style="color: black;">&lt;</span><span style="color: black;">MyEquivalencyStep</span><span style="color: black;">&gt;</span><span style="color: black;">();<br />        });<br />    }<br /><br />    [TestMethod]<br />    </span><span style="color: blue;">public</span><span style="color: black;"> </span><span style="color: blue;">void</span><span style="color: black;"> Then_it_should_precede_the_final_builtin_step()<br />    {<br />        var equivalencyStep </span><span style="color: black;">=</span><span style="color: black;"> Steps.LastOrDefault(s </span><span style="color: black;">=&gt;</span><span style="color: black;"> s </span><span style="color: blue;">is</span><span style="color: black;"> SimpleEqualityEquivalencyStep);<br />        var subjectStep </span><span style="color: black;">=</span><span style="color: black;"> Steps.LastOrDefault(s </span><span style="color: black;">=&gt;</span><span style="color: black;"> s </span><span style="color: blue;">is</span><span style="color: black;"> MyEquivalencyStep);<br /><br />        Steps.Should().HaveElementPreceding(equivalencyStep, subjectStep);<br />    }<br />}</span></div><br /></pre></div>I'm doing all of this in my private hours so side-tracking from my original goal so much is not a typical situation for me either. I fully realize that this is usually not an option in real projects. Regardless, if you ask me, you should strive for continuous improvement every single day. One practical way of tracking these kinds of refactorings is to create <a href="https://github.com/blog/1375%0A-task-lists-in-gfm-issues-pulls-comments">check lists on Github</a> or in <a href="http://www.slideshare.net/dennisdoomen/little-productivity-tools-every-developer-should-use">OneNote</a>. Another method I'm experimenting with is to insert dedicated comments to mark code as smelly or to suggest possible refactoring ideas. You can read more about this workflow in the article <a href="http://www.infoq.com/articles/natural-course-refactoring">Natural Cause of Refactoring</a>. All being well, whatever you do, please never forget The Boy Scout Rule:<br /><blockquote><em>Always leave the campground cleaner than you found it</em></blockquote>So what do you do to continuously improve your code base? Let me know by commenting below or tweeting me at <a href="https://twitter.com/ddoomen">@ddoomen</a>.