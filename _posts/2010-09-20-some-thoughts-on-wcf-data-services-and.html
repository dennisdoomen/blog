---

title: 'Silverlight Cookbook: WCF Data Services and NHibernate'
date: '2010-09-20T09:08:00.000+02:00'

tags:
- Cookbook
- Architecture
- Silverlight
- WCF
modified_time: '2011-04-01T20:36:43.377+02:00'
thumbnail: http://lh4.ggpht.com/_sv2gnsft17w/TZYbNkMfcBI/AAAAAAAAHZM/z91-AiWUWog/s72-c/clip_image0014_thumb.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-15137028.post-491801877522180415
blogger_orig_url: http://www.continuousimprover.com/2010/09/some-thoughts-on-wcf-data-services-and.html
---

<p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p>This post is part of a series of <a href="http://www.dennisdoomen.net/search/label/Cookbook">blog posts</a> detailing various aspects of the <a href="http://www.silverlightcookbook.com">Silverlight Cookbook</a>, an initiative to demonstrate proper design choices for building enterprise-class line-of-business applications with Silverlight (and WPF if you will). It currently consists out of the following parts.</p>  <ul>   <li><a href="http://www.dennisdoomen.net/2011/03/introducing-silverlight-cookbook.html">Introduction</a> </li>    <li><a href="http://www.dennisdoomen.net/2010/10/my-silverlight-4-reference-architecture_26.html">View Models, Coroutines and Binding Conventions</a> </li> </ul>  <ul>   <li><a href="http://www.dennisdoomen.net/2010/10/my-silverlight-4-reference-architecture_13.html">Domain Models and Domain Events</a> </li>    <li><a href="http://www.dennisdoomen.net/2010/10/my-silverlight-4-reference-architecture_12.html">Querying</a> </li> </ul>  <ul>   <li><a href="http://www.dennisdoomen.net/2010/10/my-silverlight-4-reference-architecture.html">Commanding</a> </li>    <li><a href="http://www.dennisdoomen.net/2010/09/some-thoughts-on-wcf-data-services-and.html">WCF Data Services &amp; NHibernate</a> </li>    <li><a href="http://www.dennisdoomen.net/2010/09/getting-more-out-of-unit-testing-in.html">BDD-Style Unit Testing of View Models</a> </li> </ul>  <ul>   <li><a href="http://www.dennisdoomen.net/2011/01/verifying-propertychanged-events-in.html">Verifying PropertyChanged events using Fluent Assertions</a> </li> </ul>  <p   $1="$1">In the Silverlight Cookbook I use a variation of the <a href="http://cqrs.wordpress.com/">CQRS</a> pattern where business-oriented commands are used to create, update or change the data, while <a href="http://msdn.microsoft.com/library/cc668792.aspx">WCF Data Services</a> (formally ADO.NET Data Services) is used as a general-purpose query service. </p>  <p   $1="$1"></p>  <p   $1="$1">Although WCF Data Services has been designed with the Entity Framework in mind, my desire to use an advanced ORM with features like 2nd level caching has let me to <a href="http://wildermuth.com/">Shawn Wildermuth</a>'s attempt to support NHibernate as a WCF Data Service <a href="http://wildermuth.com/2008/07/21/NHibernate_LINQ_with_ADO_NET_Data_Services">provider</a>. Unfortunately, that solution no longer works with NHibernate 3.x, but I managed to get it working again by compiling <a href="http://silverlightcookbook.codeplex.com/SourceControl/changeset/view/71120#1732716">my own version</a>. But regardless of all the goodness of NHibernate 3, not everything went as smooth as I hoped for. </p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1">For starters, you need to expose all entities as <em>entity sets</em> even though you use them only in associations with another parent entity and never query on them. Consider for instance that we have a Recipe entity that has an aggregate relationship with one or more Rating entities. We'll never query directly on the ratings, but we still need to expose them like this:     <br />    <br /><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160; </span><span style="color: blue; font-size: 11pt">public</span><span style="font-size: 11pt">&#160;</span><span style="color: blue; font-size: 11pt">class</span><span style="font-size: 11pt">&#160;</span><span style="color: darkblue; font-size: 11pt">RestContext</span><span style="font-size: 11pt"> : </span><span style="color: darkblue; font-size: 11pt">NHibernateContext</span></span>&#160; <br /><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160; {</span></span>&#160; <br /><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; font-size: 11pt">public</span><span style="font-size: 11pt">&#160;</span><span style="color: darkblue; font-size: 11pt">IQueryable</span><span style="font-size: 11pt">&lt;</span><span style="color: darkblue; font-size: 11pt">Recipe</span><span style="font-size: 11pt">&gt; </span><span style="color: purple; font-size: 11pt">Recipes<font color="#333333" face="Arial">&#160; <br /><font style="font-size: 11pt"></font></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {        <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: darkcyan; font-size: 11pt">get </span><span style="font-size: 11pt">{ </span><span style="color: blue; font-size: 11pt">return</span><span style="font-size: 11pt">&#160;</span><span style="color: purple; font-size: 11pt">Session</span><span style="font-size: 11pt">.</span><span style="color: darkcyan; font-size: 11pt">Query</span><span style="font-size: 11pt">&lt;</span><span style="color: darkblue; font-size: 11pt">Recipe</span><span style="font-size: 11pt">&gt;();&#160; }        <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></span></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <div style="margin: 0in">   <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; font-size: 11pt">public</span><span style="font-size: 11pt">&#160;</span><span style="color: darkblue; font-size: 11pt">IQueryable</span><span style="font-size: 11pt">&lt;</span><span style="color: darkblue; font-size: 11pt">Rating</span><span style="font-size: 11pt">&gt; </span><span style="color: purple; font-size: 11pt">Ratings          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: darkcyan; font-size: 11pt">get</span><span style="font-size: 11pt"> { </span><span style="color: blue; font-size: 11pt">return</span><span style="font-size: 11pt">&#160;</span><span style="color: purple; font-size: 11pt">Session</span><span style="font-size: 11pt">.</span><span style="color: darkcyan; font-size: 11pt">Query</span><span style="font-size: 11pt">&lt;</span><span style="color: darkblue; font-size: 11pt">Rating</span><span style="font-size: 11pt">&gt;(); }          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160; }</span></span>       <br />      <br />Another thing is that WCF Data Services chokes on the proxies that NHibernate generates at run-time. So if your entity lazy-loads another associated entity, you have to disable lazy-loading altogether. I've actually spent quite a few hours on using <a href="http://www.red-gate.com/products/reflector/">Reflector</a> to investigate whether the NHibernateContext or DataService classes could be tweaked to properly map the derived proxy class back to the appropriate entity type, but failed. As a workaround, you either need to to disable lazy-loading in the mapping, or eagerly fetch the associations using the Fetch extension method introduced in NHibernate 3:&#160; <br /><span style="font-family: calibri"><span style="font-size: 11pt">         <br />&#160;&#160;&#160; </span><span style="color: blue; font-size: 11pt">public</span><span style="font-size: 11pt">&#160;</span><span style="color: blue; font-size: 11pt">class</span><span style="font-size: 11pt">&#160;</span><span style="color: darkblue; font-size: 11pt">RestContext</span><span style="font-size: 11pt"> : </span><span style="color: darkblue; font-size: 11pt">NHibernateContext          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160; {          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; font-size: 11pt">public</span><span style="font-size: 11pt">&#160;</span><span style="color: darkblue; font-size: 11pt">IQueryable</span><span style="font-size: 11pt">&lt;</span><span style="color: darkblue; font-size: 11pt">Recipe</span><span style="font-size: 11pt">&gt; </span><span style="color: purple; font-size: 11pt">Recipes          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: darkcyan; font-size: 11pt">get          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; font-size: 11pt">return</span><span style="font-size: 11pt">&#160;</span><span style="color: purple; font-size: 11pt">Session          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; .</span><span style="color: darkcyan; font-size: 11pt">Query</span><span style="font-size: 11pt">&lt;</span><span style="color: darkblue; font-size: 11pt">Recipe</span><span style="font-size: 11pt">&gt;()          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; .</span><span style="color: darkcyan; font-size: 11pt">Fetch</span><span style="font-size: 11pt">(</span><span style="color: #a31515; font-size: 11pt"><font color="#000000">r =&gt; r.Ratings</font></span><span style="font-size: 11pt">);          <br /></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160; }</span></span></p> </div>  <div style="margin: 0in">   <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"></p> Unfortunately, that introduces another 'feature' of NHibernate. I've never quite understood why, but when NHibernate fetches one-to-many and many-to-many associations, you end up with duplicate records in the final result set. Just appending a Distinct() to the entity set getter such as the one above doesn't help. This has actually cost me a lot of time to work out, because when loading a lot of entities, the result set ended up to be too big for WCF Data Services to transfer. You'll find the solution in a hidden feature of NHibernate.Linq that allows you to add a custom action to an IQueryable expression tree like this:     <br />    <br /></div>  <p   $1="$1"></p>  <div style="margin: 0in">   <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160; queryable.</span><span style="color: purple; font-size: 11pt">QueryOptions</span><span style="font-size: 11pt">.</span><span style="color: darkcyan; font-size: 11pt">RegisterCustomAction</span><span style="font-size: 11pt">(          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; c =&gt; c.</span><span style="color: darkcyan; font-size: 11pt">SetResultTransformer</span><span style="font-size: 11pt">(</span><span style="color: blue; font-size: 11pt">new</span><span style="font-size: 11pt">&#160;</span><span style="color: darkblue; font-size: 11pt">DistinctRootEntityResultTransformer</span><span style="font-size: 11pt">()));</span></span>       <br />      <br />Since I needed to use this in many places and it obscures the intention of my code, I decided to wrap it in an extension method:</p> </div>  <p   $1="$1"></p>  <div style="margin: 0in">   <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160; </span><span style="color: blue; font-size: 11pt">public</span><span style="font-size: 11pt">&#160;</span><span style="color: blue; font-size: 11pt">static</span><span style="font-size: 11pt">&#160;</span><span style="color: blue; font-size: 11pt">class</span><span style="font-size: 11pt">&#160;</span><span style="color: darkblue; font-size: 11pt">NHibernateQueryableExtensions          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160; {          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; font-size: 11pt">public</span><span style="font-size: 11pt">&#160;</span><span style="color: blue; font-size: 11pt">static</span><span style="font-size: 11pt">&#160;</span><span style="color: darkblue; font-size: 11pt">IQueryable</span><span style="font-size: 11pt">&lt;</span><span style="color: darkblue; font-size: 11pt">TEntity</span><span style="font-size: 11pt">&gt; </span><span style="color: darkcyan; font-size: 11pt">DistinctDeferred</span><span style="font-size: 11pt">&lt;</span><span style="color: darkblue; font-size: 11pt">TEntity</span><span style="font-size: 11pt">&gt;(</span><span style="color: blue; font-size: 11pt">this</span><span style="font-size: 11pt">&#160;</span><span style="color: darkblue; font-size: 11pt">IQueryable</span><span style="font-size: 11pt">&lt;</span><span style="color: darkblue; font-size: 11pt">TEntity</span><span style="font-size: 11pt">&gt; queryable)          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; font-size: 11pt">var</span><span style="font-size: 11pt"> nHibernateQueryable = queryable </span><span style="color: blue; font-size: 11pt">as</span><span style="font-size: 11pt">&#160;</span><span style="color: darkblue; font-size: 11pt">INHibernateQueryable</span><span style="font-size: 11pt">&lt;</span><span style="color: darkblue; font-size: 11pt">TEntity</span><span style="font-size: 11pt">&gt;;</span></span></p> </div>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <div style="margin: 0in">   <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; font-size: 11pt">if</span><span style="font-size: 11pt"> (nHibernateQueryable != </span><span style="color: blue; font-size: 11pt">null</span><span style="font-size: 11pt">)          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; nHibernateQueryable.</span><span style="color: purple; font-size: 11pt">QueryOptions</span><span style="font-size: 11pt">.</span><span style="color: darkcyan; font-size: 11pt">RegisterCustomAction</span><span style="font-size: 11pt">(          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; c =&gt; c.</span><span style="color: darkcyan; font-size: 11pt">SetResultTransformer</span><span style="font-size: 11pt">(</span><span style="color: blue; font-size: 11pt">new</span><span style="font-size: 11pt">&#160;</span><span style="color: darkblue; font-size: 11pt">DistinctRootEntityResultTransformer</span><span style="font-size: 11pt">()));          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</span></span></p> </div>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <div style="margin: 0in">   <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; font-size: 11pt">return</span><span style="font-size: 11pt"> queryable;          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160; </span><span style="font-size: 11pt">}</span></span>       <br />      <br />It can be used just like the other extension methods applicable to IQueryable:</p> </div>  <p   $1="$1"></p>  <div style="margin: 0in">   <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160; </span><span style="color: blue; font-size: 11pt">public</span><span style="font-size: 11pt">&#160;</span><span style="color: darkblue; font-size: 11pt">IQueryable</span><span style="font-size: 11pt">&lt;</span><span style="color: darkblue; font-size: 11pt">Registration</span><span style="font-size: 11pt">&gt; </span><span style="color: purple; font-size: 11pt">Registrations</span></span>       <br /><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160; </span><span style="font-size: 11pt">{          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: darkcyan; font-size: 11pt">get          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="font-size: 11pt">{          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; font-size: 11pt">return</span><span style="font-size: 11pt">&#160;</span><span style="color: purple; font-size: 11pt">Session          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="font-size: 11pt">.</span><span style="color: darkcyan; font-size: 11pt">Linq</span><span style="font-size: 11pt">&lt;</span><span style="color: darkblue; font-size: 11pt">Registration</span><span style="font-size: 11pt">&gt;()          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; .</span><span style="color: darkcyan; font-size: 11pt">Expand</span><span style="font-size: 11pt">(</span><span style="color: #a31515; font-size: 11pt">&quot;Product&quot;</span><span style="font-size: 11pt">)          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; .</span><span style="color: darkcyan; font-size: 11pt">DistinctDeferred</span><span style="font-size: 11pt">();          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="font-size: 11pt">}          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160; </span><span style="font-size: 11pt">} </span></span></p> </div>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1">Since I don't do any updates through the query service, I haven't tried how well CRUD operations through WCF Data Services work. However, I did notice that in order to receive the latest changes from the server, I have to make sure to set the MergeOption property of the generated DataServiceContext subclass to MergeOption.OverwriteChanges:    <br />    <br /></p>  <p   $1="$1"></p>  <div style="margin: 0in">   <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160; </span><span style="color: purple; font-size: 11pt">queryContext</span><span style="font-size: 11pt"> = </span><span style="color: blue; font-size: 11pt">new</span><span style="font-size: 11pt">&#160;</span><span style="color: darkblue; font-size: 11pt">QueryContext</span><span style="font-size: 11pt">(queryServiceUri)          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160; </span><span style="font-size: 11pt">{          <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160; </span><span style="font-size: 11pt">&#160;&#160;&#160; </span><span style="color: purple; font-size: 11pt">MergeOption</span><span style="font-size: 11pt"> = </span><span style="color: darkblue; font-size: 11pt">MergeOption</span><span style="font-size: 11pt">.</span><span style="color: purple; font-size: 11pt"><strong>OverwriteChanges            <br /><font style="font-size: 11pt"></font></strong></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160; </span><span style="font-size: 11pt">}; </span></span></p> </div>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1">In the default setting, MergeOption.AppendOnly, it will assume all changes are made by the client, and ignore anything that occurred on the server (beats me why it does that). You can also use MergeOption.NoTracking and get the same behavior, but with MergeOption.OverwriteChanges, two queries with the same key (identified by the [DataServiceKey] attribute) will return the same physical object. This is quite convenient when binding a ComboBox to the list of available entities and the currently selected one.    <br />    <br /></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <div style="margin: 0in">   <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"><span style="font-family: inherit">To conclude this post, let me tell you that debugging WCF Data Services is definitely cumbersome. When something goes wrong or is incorrectly configured you'll only receive a generic error like this:</span>&#160;</p>    <p   $1="$1"><a href="http://lh4.ggpht.com/_sv2gnsft17w/TZYbNWnExQI/AAAAAAAAHZI/aF9CfnUakNY/s1600-h/clip_image0014%5B2%5D.png"><img style="display: inline" title="clip_image0014" alt="clip_image0014" src="http://lh4.ggpht.com/_sv2gnsft17w/TZYbNkMfcBI/AAAAAAAAHZM/z91-AiWUWog/clip_image0014_thumb.png?imgmax=800" width="560" height="101" /></a>&#160; <br /><span style="font-family: inherit">You can solve that by slapping a [ServiceBehavior] attribute to your data service class like this:</span>       <br /></p>    <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"></p>   <span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160; [</span><span style="color: darkblue; font-size: 11pt">ServiceBehavior</span><span style="font-size: 11pt">(</span><span style="color: purple; font-size: 11pt">IncludeExceptionDetailInFaults</span><span style="font-size: 11pt"> = </span><span style="color: blue; font-size: 11pt">true</span><span style="font-size: 11pt">)]        <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160; </span><span style="color: blue; font-size: 11pt">public</span><span style="font-size: 11pt">&#160;</span><span style="color: blue; font-size: 11pt">class</span><span style="font-size: 11pt">&#160;</span><span style="color: darkblue; font-size: 11pt">RestService</span><span style="font-size: 11pt"> : </span><span style="color: darkblue; font-size: 11pt">DataService</span><span style="font-size: 11pt">&lt;</span><span style="color: darkblue; font-size: 11pt">RestContext</span><span style="font-size: 11pt">&gt; { }</span></span>     <br />    <br /><span style="font-family: inherit">Or you can add the corresponding configuration setting to the &lt;behaviors&gt; element of your web.config:</span>     <br />    <br />    <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"></p>   <span style="font-family: calibri"><span style="color: blue; font-size: 11pt"><font color="#333333" face="Arial"></font>&lt;</span><span style="color: #a31515; font-size: 11pt">serviceBehaviors</span><span style="color: blue; font-size: 11pt">&gt;        <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160; </span><span style="color: blue; font-size: 11pt">&lt;</span><span style="color: #a31515; font-size: 11pt">behavior</span><span style="color: blue; font-size: 11pt">&#160;</span><span style="color: red; font-size: 11pt">name</span><span style="color: blue; font-size: 11pt">=</span><span style="font-size: 11pt">&quot;&quot;</span><span style="color: blue; font-size: 11pt">&gt;        <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; font-size: 11pt">&lt;</span><span style="color: #a31515; font-size: 11pt">serviceMetadata</span><span style="color: blue; font-size: 11pt">&#160;</span><span style="color: red; font-size: 11pt">httpGetEnabled</span><span style="color: blue; font-size: 11pt">=</span><span style="font-size: 11pt">&quot;</span><span style="color: blue; font-size: 11pt">true</span><span style="font-size: 11pt">&quot;</span><span style="color: blue; font-size: 11pt"> /&gt;</span></span>     <br /><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; font-size: 11pt">&lt;</span><span style="color: #a31515; font-size: 11pt">serviceDebug</span><span style="color: blue; font-size: 11pt">&#160;</span><span style="color: red; font-size: 11pt">includeExceptionDetailInFaults</span><span style="color: blue; font-size: 11pt">=</span><span style="font-size: 11pt">&quot;</span><span style="color: blue; font-size: 11pt">true</span><span style="font-size: 11pt">&quot;</span><span style="color: blue; font-size: 11pt"> /&gt;</span></span>     <br /><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160; </span><span style="color: blue; font-size: 11pt">&lt;/</span><span style="color: #a31515; font-size: 11pt">behavior</span><span style="color: blue; font-size: 11pt">&gt;</span></span>     <br /><span style="font-family: calibri"><span style="color: blue; font-size: 11pt">&lt;/</span><span style="color: #a31515; font-size: 11pt">serviceBehaviors</span><span style="color: blue; font-size: 11pt">&gt;        <br /><font style="font-size: 11pt"></font></span></span>    <br /><span style="font-family: inherit">Finally, you can force WCF Data Services to include a bit more info on the exception that occurred by changing the UseVerboseErrors property of the DataServiceConfiguration class.</span>&#160; <br />    <br /><span style="font-family: calibri">&#160;&#160; <span style="color: blue; font-size: 11pt">public</span><span style="font-size: 11pt">&#160;</span><span style="color: blue; font-size: 11pt">class</span><span style="font-size: 11pt">&#160;</span><span style="color: darkblue; font-size: 11pt">QueryService</span><span style="font-size: 11pt"> : </span><span style="color: darkblue; font-size: 11pt">DataService</span><span style="font-size: 11pt">&lt;</span><span style="color: darkblue; font-size: 11pt">QueryContext</span><span style="font-size: 11pt">&gt;        <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160; {        <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; </span><span style="color: blue; font-size: 11pt">public</span><span style="font-size: 11pt">&#160;</span><span style="color: blue; font-size: 11pt">static</span><span style="font-size: 11pt">&#160;</span><span style="color: blue; font-size: 11pt">void</span><span style="font-size: 11pt">&#160;</span><span style="color: darkcyan; font-size: 11pt">InitializeService</span><span style="font-size: 11pt">(</span><span style="color: darkblue; font-size: 11pt">DataServiceConfiguration</span><span style="font-size: 11pt"> config)        <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; {        <br /><font style="font-size: 11pt"></font></span></span><span style="font-family: calibri"><span style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; config.</span><span style="color: purple; font-size: 11pt">UseVerboseErrors</span><span style="font-size: 11pt"> = </span><span style="color: blue; font-size: 11pt">true</span><span style="font-size: 11pt">;</span></span> </div>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <p   $1="$1"></p>  <div style="margin: 0in">   <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"></p>    <p   $1="$1"><span style="font-family: inherit">The next time you make a mistake or some down-level query operation throws an exception, you end up with something like this:</span>       <br /></p>    <p   $1="$1"><a href="http://lh6.ggpht.com/_sv2gnsft17w/TZYbOHzLoII/AAAAAAAAHZQ/5-3vxb0SNH8/s1600-h/clip_image0024%5B2%5D.png"><img style="display: inline" title="clip_image0024" alt="clip_image0024" src="http://lh3.ggpht.com/_sv2gnsft17w/TZYbOtmea8I/AAAAAAAAHZU/2S8X9VO9Kiw/clip_image0024_thumb.png?imgmax=800" width="569" height="169" /></a></p>    <p   $1="$1"></p> </div>  