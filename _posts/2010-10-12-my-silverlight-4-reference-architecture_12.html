---

title: 'My Silverlight 4 Reference Architecture: Querying'
date: '2010-10-12T08:28:00.001+02:00'

tags:
- dotnetmag
- Architecture
- Silverlight
- WCF
modified_time: '2010-10-12T08:29:37.404+02:00'
thumbnail: http://lh6.ggpht.com/_sv2gnsft17w/TLQAEsvPYWI/AAAAAAAAGpY/w7Oerce3t7U/s72-c/clip_image001%5B6%5D_thumb%5B1%5D.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-15137028.post-4965918674183468204
blogger_orig_url: http://www.continuousimprover.com/2010/10/my-silverlight-4-reference-architecture_12.html
---

<p>After having put the <a href="http://www.dennisdoomen.net/2010/10/my-silverlight-4-reference-architecture.html">introduction</a> and the <a href="http://www.dennisdoomen.net/2010/10/my-silverlight-4-reference-architecture.html">commanding</a> part behind us, let me explain how I deal with querying. Consider the following slice of the reference <a href="http://lh5.ggpht.com/_sv2gnsft17w/TK6l3ilMR6I/AAAAAAAAGog/QTCsVCWQ2ks/s1600-h/clip_image001%5B9%5D.png">architecture</a>.&#160; </p>  <p><a href="http://lh6.ggpht.com/_sv2gnsft17w/TLQAEcqYbAI/AAAAAAAAGpQ/Ia2jIeVMbj0/s1600-h/clip_image001%5B6%5D%5B3%5D.png"><img style="background-image: none; border-right-width: 0px; margin: ; padding-left: 0px; padding-right: 0px; display: block; float: none; border-top-width: 0px; border-bottom-width: 0px; border-left-width: 0px; padding-top: 0px" title="clip_image001[6]" border="0" alt="clip_image001[6]" src="http://lh6.ggpht.com/_sv2gnsft17w/TLQAEsvPYWI/AAAAAAAAGpY/w7Oerce3t7U/clip_image001%5B6%5D_thumb%5B1%5D.png?imgmax=800" width="307" height="340" /></a></p>  <p>My original intention was to use <a href="http://msdn.microsoft.com/library/cc668792.aspx">WCF Data Services</a> combined with NHibernate on the query side. For one, because it allows you to filter the result set using a subset of the LINQ functionality at the Silverlight client. But also because it will transfer the resulting entity set including any associated relationships as one network operation; which is something that WCF RIA Services can't do. In essence it means that you don't have to explicitly convert entities to DTOs, but I kept the term in the diagram </p>  <p>However, in reality this subset of LINQ is a bit too limited. For instance, filtering an entity set based on some criteria on one of its associations (through the Any() operation) is not possible. WCF Data Services does support Service Operations, but I have never managed to get anything other than the MSDN examples to work. In fact, the Add Service Reference does not even support service operations. That's why I introduced a dedicated WCF Query Service.</p>  <p>Nevertheless, having a service class with a multitude of operations, all using one of the Repositories is a great recipe for getting a bloated class. That's why every query operation is handled by a dedicated Service Action class that handles the interaction with the repositories, preferably using an implementation of the <a href="http://en.wikipedia.org/wiki/Specification_pattern">Specification</a> pattern. Such a Specification encapsulates (a potentially very complex) query on an IQueryable&lt;T&gt; implementation and returns the matching entities:</p>  <p style="line-height: normal; margin: 0in; font-family: ; font-size: " lang="nl"><font face="Calibri"><span style="color: "><font color="#000000"><font style="font-size: 11pt">&#160;&#160;&#160; </font></font></span><font style="font-size: 11pt"><span style="color: "><font color="#0000ff">public</font></span><span style="color: "><font color="#000000">&#160;</font></span><span style="color: "><font color="#0000ff">class</font></span><span style="color: "><font color="#000000">&#160;</font></span></font><span style="color: "><font style="font-size: 11pt" color="#00008b">ActiveRegistrationsSpecification </font></span></font></p>  <p style="line-height: normal; margin: 0in; font-family: ; color: ; font-size: " lang="nl"><font face="Calibri"><font style="font-size: 11pt" color="#000000">&#160;&#160;&#160; { </font></font></p>  <p style="line-height: normal; margin: 0in; font-family: ; font-size: "><font face="Calibri"><span style="color: " lang="en-US"><font style="font-size: 11pt">&#160;&#160;&#160; </font></span><font style="font-size: 11pt"><span style="color: " lang="nl"><font color="#000000">&#160;&#160;&#160; </font></span><span style="color: " lang="en-US"><font color="#0000ff">public</font></span><span style="color: " lang="en-US">&#160;</span><span style="color: " lang="en-US"><font color="#00008b">IQueryable</font></span><span style="color: " lang="en-US">&lt;</span><span style="color: " lang="en-US"><font color="#00008b">Registration</font></span><span style="color: " lang="en-US">&gt; </span><span style="color: " lang="en-US"><font color="#008b8b">SatisfyingElementsFrom</font></span></font><span style="color: " lang="en-US"><font style="font-size: 11pt">( </font></span></font></p>  <p style="line-height: normal; margin: 0in; font-family: ; font-size: "><font face="Calibri"><span style="color: "><font style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></span><font style="font-size: 11pt"><span style="color: "><font color="#00008b">IQueryable</font></span><span style="color: ">&lt;</span><span style="color: "><font color="#00008b">Registration</font></span></font><span style="color: "><font style="font-size: 11pt">&gt; registrations) </font></span></font></p>  <p style="line-height: normal; margin: 0in; font-family: ; font-size: "><font face="Calibri"><span style="color: " lang="en-US"><font style="font-size: 11pt">&#160;&#160;&#160; </font></span><font style="font-size: 11pt"><span style="color: " lang="nl"><font color="#000000">&#160;&#160;&#160; </font></span></font><span style="color: " lang="en-US"><font style="font-size: 11pt">{ </font></span></font></p>  <p style="line-height: normal; margin: 0in; font-family: ; font-size: " lang="nl"><font face="Calibri"><span style="color: "><font color="#000000"><font style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></font></span><font style="font-size: 11pt"><span style="color: "><font color="#0000ff">return</font></span><span style="color: "><font color="#000000"> registrations.</font></span><span style="color: "><font color="#008b8b">Where</font></span><span style="color: "><font color="#000000">(r =&gt; r.</font></span><span style="color: "><font color="#800080">Status</font></span><span style="color: "><font color="#000000"> != </font></span><span style="color: "><font color="#00008b">AgreementStatus</font></span><span style="color: "><font color="#000000">.</font></span><span style="color: ; font-weight: "><font color="#800080"><strong>Incomplete</strong></font></span></font><span style="color: "><font style="font-size: 11pt" color="#000000">); </font></span></font></p>  <p style="line-height: normal; margin: 0in; font-family: ; font-size: "><font face="Calibri"><span style="color: " lang="en-US"><font style="font-size: 11pt">&#160;&#160;&#160; </font></span><font style="font-size: 11pt"><span style="color: " lang="nl"><font color="#000000">&#160;&#160;&#160; </font></span></font><span style="color: " lang="en-US"><font style="font-size: 11pt">} </font></span></font></p>  <p style="line-height: normal; margin: 0in; font-family: ; font-size: "><font face="Calibri"><span style="color: " lang="nl"><font color="#000000"><font style="font-size: 11pt">&#160;&#160;&#160; }</font></font></span><span style="color: " lang="en-US"><font style="font-size: 11pt"> </font></span></font></p>  <p>The beauty of this pattern is that you can easily verify its behavior by passing in an arbitrary in-memory collection and observing the resulting subset from a unit test. At run-time, the repository will simply pass an IQueryable&lt;T&gt; implementation that directly talks to <a href="http://sourceforge.net/projects/nhibernate/files/">LINQ-to-NHibernate</a>.</p>  <p>I already <a href="http://www.dennisdoomen.net/2010/09/some-thoughts-on-wcf-data-services-and.html">blogged</a> about the combination of NHibernate and WCF Data Services, so I will refrain from repeating myself. However, one thing to remember when working with Silverlight, is that it doesn't really work well with services that throw FaultExceptions. In fact, it does not even understand them and treat them like a generic error 500. Luckely, the MSDN library contains a great article that explains how to introduce a <a href="http://msdn.microsoft.com/en-us/library/ee844556%28VS.96%29.aspx">custom Endpoint Behavior</a> to overcome this. For the lazy people among us, get the <a href="http://thecqrskitchen.codeplex.com/SourceControl/changeset/view/61409#1634976">code</a> from my <a href="http://thecqrskitchen.codeplex.com/">CQRS example</a> so that you tuck its extension element in your web.config like this:     <br /></p>  <p style="line-height: normal; margin: 0in; font-family: ; font-size: "><font face="Calibri"><span style="color: "><font color="#0000ff"><font style="font-size: 11pt">&lt;</font></font></span><font style="font-size: 11pt"><span style="color: "><font color="#a31515">configuration</font></span></font><span style="color: "><font style="font-size: 11pt" color="#0000ff">&gt;</font></span></font></p>  <p style="line-height: normal; margin: 0in; font-family: ; font-size: "><font face="Calibri"><span style="color: " lang="nl"><font color="#0000ff"><font style="font-size: 11pt">&#160; &lt;</font></font></span><font style="font-size: 11pt"><span style="color: " lang="en-US"><font color="#a31515">system.serviceModel</font></span></font><span style="color: " lang="en-US"><font style="font-size: 11pt" color="#0000ff">&gt;</font></span></font></p>  <p style="line-height: normal; margin: 0in; font-family: ; font-size: "><font face="Calibri"><span style="color: " lang="nl"><font color="#0000ff"><font style="font-size: 11pt">&#160;&#160;&#160; &lt;</font></font></span><font style="font-size: 11pt"><span style="color: " lang="en-US"><font color="#a31515">extensions</font></span></font><span style="color: " lang="en-US"><font style="font-size: 11pt" color="#0000ff">&gt;</font></span></font></p>  <p style="line-height: normal; margin: 0in; font-family: ; font-size: "><font face="Calibri"><span style="color: " lang="nl"><font color="#0000ff"><font style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160; &lt;</font></font></span><font style="font-size: 11pt"><span style="color: " lang="en-US"><font color="#a31515">behaviorExtensions</font></span></font><span style="color: " lang="en-US"><font style="font-size: 11pt" color="#0000ff">&gt;</font></span></font></p>  <p style="line-height: normal; margin: 0in; font-family: ; font-size: "><font face="Calibri"><span style="color: " lang="nl"><font color="#0000ff"><font style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</font></font></span><font style="font-size: 11pt"><span style="color: " lang="en-US"><font color="#a31515">add</font></span><span style="color: " lang="en-US"><font color="#0000ff">&#160;</font></span><span style="color: " lang="en-US"><font color="#ff0000">name</font></span><span style="color: " lang="en-US"><font color="#0000ff">=</font></span><span style="color: " lang="en-US">&quot;</span><span style="color: " lang="en-US"><font color="#0000ff">silverlightFaults</font></span></font><span style="color: " lang="en-US"><font style="font-size: 11pt">&quot;</font></span></font></p>  <p style="line-height: normal; margin: 0in; font-family: ; font-size: "><font face="Calibri"><span style="color: " lang="nl"><font color="#0000ff"><font style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; </font></font></span><font style="font-size: 11pt"><span style="color: " lang="en-US"><font color="#ff0000">type</font></span><span style="color: " lang="en-US"><font color="#0000ff">=</font></span><span style="color: " lang="en-US">&quot;</span><span style="color: " lang="en-US"><font color="#0000ff">TheKitchen.Common.SilverlightFaultBehavior, TheKitchen.Common, Version=1.0.0.0, Culture=neutral, PublicKeyToken=null</font></span><span style="color: " lang="en-US">&quot;</span></font><span style="color: " lang="en-US"><font style="font-size: 11pt" color="#0000ff">/&gt;</font></span></font></p>  <p style="line-height: normal; margin: 0in; font-family: ; font-size: "><font face="Calibri"><span style="color: " lang="nl"><font color="#0000ff"><font style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160; &lt;/</font></font></span><font style="font-size: 11pt"><span style="color: " lang="en-US"><font color="#a31515">behaviorExtensions</font></span></font><span style="color: " lang="en-US"><font style="font-size: 11pt" color="#0000ff">&gt;</font></span></font></p>  <p style="line-height: normal; margin: 0in; font-family: ; font-size: "><font face="Calibri"><span style="color: " lang="nl"><font color="#0000ff"><font style="font-size: 11pt">&#160;&#160;&#160; &lt;/</font></font></span><font style="font-size: 11pt"><span style="color: " lang="en-US"><font color="#a31515">extensions</font></span></font><span style="color: " lang="en-US"><font style="font-size: 11pt" color="#0000ff">&gt;</font></span></font></p>  <p style="line-height: normal; margin: 0in; font-family: ; font-size: "><font face="Calibri"><span style="color: " lang="nl"><font color="#0000ff"><font style="font-size: 11pt">&#160;&#160;&#160; &lt;</font></font></span><font style="font-size: 11pt"><span style="color: " lang="en-US"><font color="#a31515">behaviors</font></span></font><span style="color: " lang="en-US"><font style="font-size: 11pt" color="#0000ff">&gt;</font></span></font></p>  <p style="line-height: normal; margin: 0in; font-family: ; font-size: "><font face="Calibri"><span style="color: " lang="nl"><font color="#0000ff"><font style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160; &lt;</font></font></span><font style="font-size: 11pt"><span style="color: " lang="en-US"><font color="#a31515">endpointBehaviors</font></span></font><span style="color: " lang="en-US"><font style="font-size: 11pt" color="#0000ff">&gt;</font></span></font></p>  <p style="line-height: normal; margin: 0in; font-family: ; font-size: "><font face="Calibri"><span style="color: " lang="nl"><font color="#0000ff"><font style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</font></font></span><font style="font-size: 11pt"><span style="color: " lang="en-US"><font color="#a31515">behavior</font></span><span style="color: " lang="en-US"><font color="#0000ff">&#160;</font></span><span style="color: " lang="en-US"><font color="#ff0000">name</font></span><span style="color: " lang="en-US"><font color="#0000ff">=</font></span><span style="color: " lang="en-US">&quot;&quot;</span></font><span style="color: " lang="en-US"><font style="font-size: 11pt" color="#0000ff">&gt;</font></span></font></p>  <p style="line-height: normal; margin: 0in; font-family: ; font-size: "><font face="Calibri"><span style="color: " lang="nl"><font color="#0000ff"><font style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;</font></font></span><font style="font-size: 11pt"><span style="color: " lang="en-US"><font color="#a31515">silverlightFaults</font></span></font><span style="color: " lang="en-US"><font style="font-size: 11pt" color="#0000ff">/&gt;</font></span></font></p>  <p style="line-height: normal; margin: 0in; font-family: ; font-size: "><font face="Calibri"><span style="color: " lang="nl"><font color="#0000ff"><font style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160;&#160;&#160; &lt;/</font></font></span><font style="font-size: 11pt"><span style="color: " lang="en-US"><font color="#a31515">behavior</font></span></font><span style="color: " lang="en-US"><font style="font-size: 11pt" color="#0000ff">&gt;</font></span></font></p>  <p style="line-height: normal; margin: 0in; font-family: ; font-size: "><font face="Calibri"><span style="color: " lang="nl"><font color="#0000ff"><font style="font-size: 11pt">&#160;&#160;&#160;&#160;&#160; &lt;/</font></font></span><font style="font-size: 11pt"><span style="color: " lang="en-US"><font color="#a31515">endpointBehaviors</font></span></font><span style="color: " lang="en-US"><font style="font-size: 11pt" color="#0000ff">&gt;</font></span></font></p>  <p style="line-height: normal; margin: 0in; font-family: ; font-size: "><font face="Calibri"><span style="color: " lang="nl"><font color="#0000ff"><font style="font-size: 11pt">&#160;&#160;&#160; &lt;/</font></font></span><font style="font-size: 11pt"><span style="color: " lang="en-US"><font color="#a31515">behaviors</font></span></font><span style="color: " lang="en-US"><font style="font-size: 11pt" color="#0000ff">&gt;</font></span></font></p>  <p style="line-height: normal; margin: 0in; font-family: ; font-size: "><font face="Calibri"><span style="color: " lang="nl"><font color="#0000ff"><font style="font-size: 11pt">&#160; &lt;/</font></font></span><font style="font-size: 11pt"><span style="color: " lang="en-US"><font color="#a31515">system.serviceModel</font></span></font><span style="color: " lang="en-US"><font style="font-size: 11pt" color="#0000ff">&gt;</font></span></font></p>  <p style="line-height: normal; margin: 0in; font-family: ; font-size: "><font face="Calibri"><span style="color: " lang="nl"><font color="#0000ff"><font style="font-size: 11pt">&lt;/</font></font></span><font style="font-size: 11pt"><span style="color: " lang="en-US"><font color="#a31515">configuration</font></span></font><span style="color: " lang="en-US"><font style="font-size: 11pt" color="#0000ff">&gt;</font></span></font></p>  <p>Next time, I’ll deal a bit with the domain model.</p>  