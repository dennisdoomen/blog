---

title: Bringing the power of PowerShell to your build scripts
date: '2015-03-22T19:38:00.001+01:00'

tags:
- psake
- powershell
modified_time: '2015-03-22T19:55:08.060+01:00'
thumbnail: http://lh4.ggpht.com/-J5LSLMiMuBE/VQ8MPiaGK5I/AAAAAAAAKOI/ZkISlXPTEKo/s72-c/clip_image001_thumb%25255B15%25255D.png?imgmax=800
blogger_id: tag:blogger.com,1999:blog-15137028.post-908078139532234381
blogger_orig_url: http://www.continuousimprover.com/2015/03/bringing-power-of-powershell-to-your.html
---

If you look back at the last couple of years, you'll notice an increasing attention for best practices that should make us more professional software developers. We design our classes using Test Driven Development, we review our code in pairs, and we apply all kinds of architectural principles such as those represented by the <a href="http://www.infoq.com/news/2013/08/solid-principles-revisited">S.O.L.I.D.</a> acronym. In other words, we really care about our code. But what about our build scripts? Do we care as much about those as we do for our regular code? I doubt it, but shouldn't we? <br /><br />About a year ago we switched from <a href="https://www.visualstudio.com/en-us/products/tfs-overview-vs.aspx">Microsoft Team Foundation Server</a>'s build environment to <a href="https://www.jetbrains.com/teamcity/features/">JetBrains TeamCity</a>, mostly because my client was moving to Git and GitHub. After being used to the cryptic MSBuild XML documents (I never bothered with the Windows Workflow Foundation stuff), being able to use TeamCity's elaborate build step system seemed like an attractive approach. But with that, we almost made the mistake of treating build scripts as something exotic again.<br /><br />Luckily, my (then new) colleague <a href="https://www.google.nl/url?sa=t&amp;rct=j&amp;q=&amp;esrc=s&amp;source=web&amp;cd=1&amp;cad=rja&amp;uact=8&amp;ved=0CCIQFjAA&amp;url=https%3A%2F%2Ftwitter.com%2Frandompunter&amp;ei=CrENVYvlOcHW7QbLgIGoAg&amp;usg=AFQjCNF_4kzmUSOcUhdLQr5LccvaF7LWdw&amp;sig2=ezh9xc1Mdg0dhA79fLnKRA&amp;bvm=bv.88528373,d.ZGU">Damian Hickey</a> convinced us to look at how the open-source community solves the build problem. Quite a lot of these projects use either a .bat file that directly invokes the msbuild executable or use <a href="http://blogs.technet.com/b/heyscriptingguy/archive/2009/04/20/windows-powershell-an-introduction.aspx">PowerShell</a> to do the same thing. As the teams didn't have any prior experience with PowerShell, being able to use TeamCity's graphical user interface sounded like the way to go. <br /><br />Tying the build process to TeamCity has some drawbacks however.<br /><ul><li>You can't run a build outside TeamCity. Being able to fully test whether your local changes are working correctly becomes an invaluable capability that you really start to appreciate once you have it. </li><li>A codebase evolves over time, potentially involving changes in the way the code is build, tested and/or deployed. You wouldn't want to have separate build definitions for different branches, or worse, align the build definition with the changes in the code-base. </li><li>Being able to treat your build scripts as first-class citizens of your code base also enables the capabilities you are used to such as merging changes from different contributions, supporting <a href="https://help.github.com/articles/using-pull-requests/">pull requests</a>, and analyzing the history of your script. Although TeamCity supports auditing, it'll be a completely different experience. </li><li>Although TeamCity is a state-of-the-art build engine, especially compared to Microsoft Team Build, being able to switch to another build product (such as <a href="http://www.appveyor.com/">AppVeyor</a>) is a big advantage. </li></ul><br />So putting your build definition in source control, next the code base it builds, was a big advantage for us. And though we didn't have much prior PowerShell experience, <a href="http://blogs.technet.com/b/heyscriptingguy/archive/2012/02/11/why-use-net-framework-classes-from-within-powershell.aspx">being able</a> to use .NET classes provides a lot of flexibility. We decided to use an open-source PowerShell library called <a href="https://github.com/psake/psake">PSake</a> (pronounced as sake) that combines the concepts of the old <a href="http://en.wikipedia.org/wiki/Make_%28software%29">make</a> build language with the power of PowerShell. <br /><br />After unzipping the release and adding the files to your source control repository, a simple default.ps1 file might look like this:<br /><div class="wlWriterEditableSmartContent" id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:3a9b4046-e0df-4593-9a13-c0c08d9556cc" style="display: inline; float: none; margin: 0px; padding: 0px;"><pre style="background-color: white; font-family: Tahoma; font-size: 9.75px; height: 146px; overflow: auto; width: 770px;"><div><br /><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="font-size: large;"><span style="font-size: small;"><span style="color: black;">task </span><span style="color: blue;">default</span><span style="color: black;"> </span><span style="color: black;">-</span><span style="color: black;">depends Compile<br /><br />task Compile </span><span style="color: black;">-</span><span style="color: black;">description </span><span style="color: maroon;">"</span><span style="color: maroon;">Compiles the solution</span><span style="color: maroon;">"</span><span style="color: black;">  {<br />    exec { <br />        msbuild </span><span style="color: black;">/</span><span style="color: black;">v:m </span><span style="color: black;">/</span><span style="color: black;">p:Platform</span><span style="color: black;">=</span><span style="color: maroon;">"</span><span style="color: maroon;">Any CPU</span><span style="color: maroon;">"</span><span style="color: black;"> TestApplication.sln </span><span style="color: black;">/</span><span style="color: black;">p:Configuration</span><span style="color: black;">=</span><span style="color: black;">Release </span><span style="color: black;">/</span><span style="color: black;">t:Rebuild<br />    }<br />}</span></span></span></div><br /></pre><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --><br /></div><br />Notice that both <u><em>msbuild</em></u> and <em>exec</em> are wrapper functions provided by PSake. The first ensures that the right version of msbuild for the appropriate .NET Framework is used. The second ensures that the last exit code of a DOS command-line is converted in the correct PowerShell exception. You can run this build script using <em>psake.ps1</em> or <em>psake.cmd</em>, depending on whether you're running it from a PowerShell console or a Command Prompt. <br /><br /><br /><a href="http://lh3.ggpht.com/-t-h-2yy3w5A/VQ8MOi2d40I/AAAAAAAAKOE/ytzynxRwp0s/s1600-h/clip_image001%25255B18%25255D.png"><img alt="clip_image001" border="0" src="http://lh4.ggpht.com/-J5LSLMiMuBE/VQ8MPiaGK5I/AAAAAAAAKOI/ZkISlXPTEKo/clip_image001_thumb%25255B15%25255D.png?imgmax=800" height="261" style="background-image: none; border-width: 0px; display: block; float: none; margin-left: auto; margin-right: auto; padding-left: 0px; padding-right: 0px; padding-top: 0px;" title="clip_image001" width="514" /></a><br />Since the default behavior is to run the default task in the default.ps1 script, you don't need to provide any parameters. If you want, you can specify an explicit task to run. Just run psake.cmd -help or psake.ps1 -help to get the very extensive help page.<br /><br />Now suppose you want to parameterize the project's solution configuration (from release to debug). PSake supports script properties for which you can pass values as part of the Psake.cmd call.<br /><div class="wlWriterEditableSmartContent" id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:b78fb7d6-81e9-4aa7-a535-9dba45bdf3d3" style="display: inline; float: none; margin: 0px; padding: 0px;"><pre style="background-color: white; font-family: Tahoma; font-size: 9.75px; height: 236px; overflow: auto; width: 752px;"><div><br /><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="font-size: small;"><span style="color: black;">properties {<br />    </span><span style="color: purple;">$Configuration</span><span style="color: black;"> </span><span style="color: black;">=</span><span style="color: black;"> </span><span style="color: maroon;">"</span><span style="color: maroon;">Release</span><span style="color: maroon;">"</span><span style="color: black;"><br />}<br /><br />task </span><span style="color: blue;">default</span><span style="color: black;"> </span><span style="color: black;">-</span><span style="color: black;">depends Compile<br /><br />task Compile {<br />    exec { <br />        msbuild </span><span style="color: black;">/</span><span style="color: black;">v:m </span><span style="color: black;">/</span><span style="color: black;">p:Platform</span><span style="color: black;">=</span><span style="color: maroon;">"</span><span style="color: maroon;">Any CPU</span><span style="color: maroon;">"</span><span style="color: black;"> TestApplication.sln </span><span style="color: black;">/</span><span style="color: black;">p:Configuration</span><span style="color: black;">=</span><span style="color: purple;">$Configuration</span><span style="color: black;"> </span><span style="color: black;">/</span><span style="color: black;">t:Rebuild<br />    }<br />}</span></span></div><br /></pre><br /><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --><br /></div>Now when you run the following it'll build the debug version of the solution. <br /><br /><br /><div class="wlWriterEditableSmartContent" id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:97d7f78c-054c-4626-b75d-bcb7bdb8ae37" style="display: inline; float: none; margin: 0px; padding: 0px;"><pre style="background-color: white; font-family: Tahoma; height: 39px; overflow: auto; width: 752px;"><div><br /><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="color: black;">.\psake.ps1 </span><span style="color: black;">-</span><span style="color: black;">properties </span><span style="color: black;">@</span><span style="color: black;">{</span><span style="color: maroon;">"</span><span style="color: maroon;">Configuration</span><span style="color: maroon;">"</span><span style="color: black;">=</span><span style="color: maroon;">"</span><span style="color: maroon;">Debug</span><span style="color: maroon;">"</span><span style="color: black;">) </span></div><br /></pre><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --><br /></div>In most projects, your build script will consist of multiple tasks each depending on other tasks. In the previous example, the default task depends on the Compile task. Obviously, much more elaborate dependencies are possible, including conditions. <br /><br /><br /><div class="wlWriterEditableSmartContent" id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:622aac7c-9bd9-4da3-a606-062dff9f5785" style="display: inline; float: none; margin: 0px; padding: 0px;"><pre style="background-color: white; font-family: Tahoma; font-size: 9.75px; height: 287px; overflow: auto; width: 752px;"><div><br /><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="font-size: small;"><span style="color: black;">properties {<br />    </span><span style="color: purple;">$PackageName</span><span style="color: black;"> </span><span style="color: black;">=</span><span style="color: black;"> </span><span style="color: maroon;">""</span><span style="color: black;"><br />}<br /><br />task </span><span style="color: blue;">default</span><span style="color: black;"> </span><span style="color: black;">-</span><span style="color: black;">depends Compile, BuildNugetPackage<br /><br />task Compile {<br /><br />}<br /><br />task BuildNugetPackage </span><span style="color: black;">-</span><span style="color: black;">depends Compile </span><span style="color: black;">-</span><span style="color: black;">precondition { </span><span style="color: purple;">$PackageName</span><span style="color: black;"> </span><span style="color: teal;">-ne</span><span style="color: black;"> </span><span style="color: maroon;">""</span><span style="color: black;"> } {<br /><br />}</span></span></div><br /></pre><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --><br /></div>So in addition to verifying that the <em>$PackageName</em> variable must be specified as a property, you can also run the <em>BuildNugetPackage</em> task directly. But since it depends on the <em>Compile</em> step, the net result is the same as just running the default task. It's good practice to add the essential dependencies. BTW, if you want to make that package name property mandatory, you can write the task like this:<br /><br /><br /><br /><div class="wlWriterEditableSmartContent" id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:cafbc0b5-ac39-4456-b5a7-1acf5528d3cf" style="display: inline; float: none; margin: 0px; padding: 0px;"><pre style="background-color: white; font-family: Tahoma; font-size: 9.75px; height: 78px; overflow: auto; width: 752px;"><div><br /><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="font-size: small;"><span style="color: black;">task BuildNugetPackage </span><span style="color: black;">-</span><span style="color: black;">depends Compile </span><span style="color: black;">-</span><span style="color: black;">requiredVariables </span><span style="color: purple;">$PackageName</span><span style="color: black;"> {<br /><br />}</span></span></div><br /></pre><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --><br /></div>Notice that running this build script from a build product is just going to route the PowerShell output as the build output. However, both TeamCity and AppVeyor have ways to enable more deep integration. For instance, TeamCity will recognize <a href="https://confluence.jetbrains.com/display/TCD7/Build+Script+Interaction+with+TeamCity">certain phrases</a> in the output and use that to interpret the phase of the build or the severity of certain build problems:<br /><br /><br /><div class="wlWriterEditableSmartContent" id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:b7a2e7c7-de69-484b-8bb4-d05407ec9f40" style="display: inline; float: none; margin: 0px; padding: 0px;"><pre style="background-color: white; font-family: Tahoma; font-size: 9.75px; height: 159px; overflow: auto; width: 752px;"><div><br /><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="font-size: small;"><span style="color: black;">task Compile {<br />    </span><span style="color: maroon;">"</span><span style="color: maroon;">##teamcity[blockOpened name='Compilation']</span><span style="color: maroon;">"</span><span style="color: black;"><br /><br />    </span><span style="color: green;">#</span><span style="color: green;"> compilation steps</span><span style="color: green;"><br /></span><span style="color: black;"><br />    </span><span style="color: maroon;">"</span><span style="color: maroon;">##teamcity[blockClosed name='Compilation']</span><span style="color: maroon;">"</span><span style="color: black;"><br />}</span></span></div><br /></pre><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --><br /></div>But since PSake will scan and load <a href="https://msdn.microsoft.com/en-us/library/dd878324%28v=vs.85%29.aspx">PowerShell modules</a> (.psm1 files) from under the Modules folder, you can make this a lot more readable by importing the <a href="https://github.com/dennisdoomen/fluentassertions/blob/develop/Build/Modules/teamcity.psm1">TeamCity extensions</a> provided by the <a href="https://github.com/psake/psake-contrib">Psake Contrib</a> project:<br /><div class="wlWriterEditableSmartContent" id="scid:9D7513F9-C04C-4721-824A-2B34F0212519:feb40583-0ec8-409d-8daa-f61093e05bf2" style="display: inline; float: none; margin: 0px; padding: 0px;"><pre style="background-color: white; font-family: Tahoma; font-size: 9.75px; height: 119px; overflow: auto; width: 752px;"><div><br /><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="font-size: small;"><span style="color: black;">task Compile {<br />    TeamCity</span><span style="color: black;">-</span><span style="color: black;">Block </span><span style="color: maroon;">"</span><span style="color: maroon;">Compiling the solution</span><span style="color: maroon;">"</span><span style="color: black;"> { <br />    <br />    }<br />}</span></span></div><br /></pre><br /><!-- Code inserted with Steve Dunn's Windows Live Writer Code Formatter Plugin.  http://dunnhq.com --><br /></div>AppVeyor offers <a href="http://www.appveyor.com/docs/build-worker-api">PowerShell extensions</a> to interact with their build system as well. And don't underestimate the capability of using PowerShell modules here. This is what will allow you to treat your PSake scripts as real code including opportunities for refactoring, code reuse, accepting open-source contributions, etc. <br /><br />Anyway, this post was in no way meant to be a comprehensive discussion on Psake. Instead, I recommend you to checkout out the <a href="https://github.com/psake/psake/tree/master/examples">many examples</a> from the GitHub repository or look at the <a href="https://github.com/dennisdoomen/fluentassertions/blob/develop/Build/default.ps1">build script</a> that I'm using to build <a href="http://www.fluentassertions.com/">Fluent Assertions</a> from CodeBetter's <a href="http://teamcity.codebetter.com/viewType.html?buildTypeId=bt1236">TeamCity</a> environment. <br /><br />So how do you organize your build environment? Does what I'm proposing here make sense? Let me know by commenting below or tweeting me at <a href="https://twitter.com/ddoomen">@ddoomen</a>.