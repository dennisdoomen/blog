---

title: Ingredients for well-designed OWIN middleware components - Part 4
date: '2015-07-22T07:24:00.002+02:00'

tags:
- OWIN Recipes
modified_time: '2015-10-09T10:08:48.183+02:00'
blogger_id: tag:blogger.com,1999:blog-15137028.post-5938752857434558924
blogger_orig_url: http://www.continuousimprover.com/2015/07/ingredients-for-well-designed-owin_22.html
---

<div style="margin: 0in;"><span style="font-family: inherit;">In my <a href="http://www.continuousimprover.com/2015/07/ingredients-for-well-designed-owin_21.html">last post</a> I talked about unit testing your OWIN pipeline and briefly mentioned that you shouldn't do any heavy lifting from inside your </span><span style="font-family: Courier New, Courier, monospace;">UseWhatever</span><span style="font-family: inherit;"> method. Examples of that include starting background tasks or connecting to other services (through that </span><span style="font-family: Courier New, Courier, monospace;">HttpMessageHandler</span><span style="font-family: inherit;">). If you're lucky, those tasks can be initiated in a laziness fashion. For instance, your component could use the first incoming request as a trigger to start that thread. However, some components might want to start processing some data as early as possible just to make sure that data is ready when the first request comes in. So how do you initiate those things instead? </span></div><div style="margin: 0in;"><br /><b>Ingredient 5: Postpone the heavily lifting using startable components</b></div><div style="margin: 0in;"><span style="font-family: inherit;">Well, there's no real best practice, but what worked well for us is to return an object from the </span><span style="font-family: Courier New, Courier, monospace;">UseXXX</span><span style="font-family: inherit;"> extension method that implements </span><span style="font-family: Courier New, Courier, monospace;">IStartable</span><span style="font-family: inherit;"> and exposes a single asynchronous </span><span style="font-family: Courier New, Courier, monospace;">Start</span><span style="font-family: inherit;"> method. </span></div><div style="margin: 0in;"><br /></div><div style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">&nbsp;&nbsp;&nbsp; public class Startable : IStartable</span></div><div style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">&nbsp;&nbsp;&nbsp; {</span></div><div style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; private readonly Func&lt;Task</span><span style="font-family: 'Courier New', Courier, monospace;">&gt;</span><span style="font-family: Courier New, Courier, monospace;"><task>&nbsp;starterFunc;</task></span></div><div lang="nl" style="margin: 0in;"><br /></div><div style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public Startable(Func&lt;</span><span style="font-family: 'Courier New', Courier, monospace;">Task&gt;&nbsp;</span><span style="font-family: 'Courier New', Courier, monospace;">starterFunc)</span></div><div style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</span></div><div style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; this.starterFunc = starterFunc;</span></div><div style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></div><div lang="nl" style="margin: 0in;"><br /></div><div style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; public Task Start()</span></div><div style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; {</span></div><div style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; return starterFunc();</span></div><div style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }</span></div><div style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">&nbsp;&nbsp;&nbsp; }</span></div><div style="margin: 0in;"><br /></div><div style="margin: 0in;"><span style="font-family: inherit;">Within your middleware extension method you can use it like this:</span></div><div style="margin: 0in;"><br /></div><div style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">&nbsp; public static IStartable UseMyComponent(this IAppBuilder appBuilder)</span></div><div style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">&nbsp; {</span></div><div style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">&nbsp;&nbsp;&nbsp; // Add whatever nested middleware or WebAPI stuff you need to the appBuilder</span></div><div style="margin: 0in;"><br /></div><div style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">&nbsp;&nbsp;&nbsp; return new Startable(() =&gt; async {</span></div><div style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; // Do the heavy lifting such as creating threads, etc.</span></div><div style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; await â€¦</span></div><div style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">&nbsp;&nbsp;&nbsp; })</span></div><br /><div style="margin: 0in;"><span style="font-family: Courier New, Courier, monospace;">&nbsp; }</span></div>